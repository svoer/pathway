<!DOCTYPE html>
<html lang="fr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enovacom Pathway</title>

  <!-- Libs (en prod: Tailwind via CLI/PostCSS) -->
  <script src="https://unpkg.com/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <!-- Webfonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?
family=Inter:wght@400;600;800&
family=Work+Sans:wght@400;600;700&
family=Manrope:wght@400;600;700&
family=Montserrat:wght@500;700&
family=JetBrains+Mono:wght@600;700&
family=Roboto:wght@400;500;700&
family=Open+Sans:wght@400;600;700&
family=Lato:wght@400;700&
family=Poppins:wght@400;600;700&
family=Nunito:wght@400;600;800&
family=Raleway:wght@400;600;700&
family=Ubuntu:wght@400;500;700&
family=Playfair+Display:wght@400;700&
family=Merriweather:wght@400;700&
family=Source+Code+Pro:wght@400;600&
family=Fira+Code:wght@400;600&
family=Courier+Prime:wght@400;700&
family=Space+Mono:wght@400;700&
family=Quicksand:wght@400;600;700&
family=Comfortaa:wght@400;600;700&
family=Pacifico&
family=Lobster&
family=Dancing+Script:wght@400;700&
family=Righteous&
family=Permanent+Marker&
family=Bebas+Neue&
family=Oswald:wght@400;600&
family=Indie+Flower&
family=Shadows+Into+Light&
family=Caveat:wght@400;700&
family=Archivo:wght@400;600;700&
family=Barlow:wght@400;600;700&
family=DM+Sans:wght@400;500;700&
family=Exo+2:wght@400;600;700&
family=Karla:wght@400;600;700&
family=Outfit:wght@400;600;700&
family=Plus+Jakarta+Sans:wght@400;600;700&
family=Sora:wght@400;600;700&
family=Space+Grotesk:wght@400;600;700&
family=Lexend:wght@400;600;700&
family=Red+Hat+Display:wght@400;600;700&
family=Figtree:wght@400;600;700&display=swap" />

  <style>
    [x-cloak]{display:none!important;}
    :root{
      /* Enovacom (sert aussi quand th√®me = Enovacom pour l'UI) */
      --primary:#0C4A45; --primary-light:#0f5650; --primary-dark:#083832;
      --accent:#22c55e; --accent-light:#4ade80;
      --surface:#ffffff; --surface-elevated:#fafafa; --surface-border:#e5e7eb;
      --text:#111827; --text-2:#6b7280; --muted:#9ca3af;
      --r-sm:10px; --r-md:14px; --r-lg:18px;
      --shadow-s:0 1px 3px 0 rgba(0,0,0,.08),0 1px 2px 0 rgba(0,0,0,.04);
      --shadow-m:0 5px 10px rgba(0,0,0,.06);
      --shadow-l:0 12px 24px rgba(0,0,0,.08);
    }
    *{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{background:linear-gradient(180deg,#fafafa 0%,#f3f4f6 100%);color:var(--text);-webkit-font-smoothing:antialiased}
    .modern-header{background:var(--surface);border-bottom:1px solid var(--surface-border);backdrop-filter:blur(10px);box-shadow:var(--shadow-s)}
    .brand-logo{font-weight:800;font-size:1.5rem;color:var(--primary);letter-spacing:-.02em}
    .brand-tagline{font-weight:500;font-size:.9rem;color:var(--text-2);margin-left:.5rem;padding-left:.5rem;border-left:2px solid var(--surface-border)}

    .neo-card{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--r-lg);box-shadow:var(--shadow-s);transition:transform .15s ease}
    .neo-card:hover{transform:translateY(-1px)}
    .neo-card-header{padding:1.1rem 1.1rem 0 1.1rem;border-bottom:1px solid var(--surface-border);margin-bottom:1.1rem}
    .section-title{font-weight:600;font-size:1.1rem}

    .neo-input{width:100%;padding:.8rem 1rem;border:1.5px solid var(--surface-border);border-radius:12px;background:var(--surface);font-weight:500}
    .neo-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(12,74,69,.12);outline:0}
    .neo-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .75rem center;background-size:1rem;padding-right:2.5rem}

    .neo-btn{display:inline-flex;align-items:center;justify-content:center;height:44px;padding:0 1rem;border-radius:12px;border:1px solid var(--surface-border);background:var(--surface-elevated);cursor:pointer}
    .neo-btn:hover{background:#fff;box-shadow:var(--shadow-s)}
    .neo-btn-primary{background:var(--primary);color:#fff;border:none}
    .neo-btn-primary:hover{background:var(--primary-light);box-shadow:var(--shadow-m)}
    .neo-btn-icon{width:44px;padding:0}
    .is-recording{background:rgba(242,101,80,.12);border-color:#f26950}

    .preview-container{background:var(--surface);border:1px solid var(--surface-border);border-radius:14px;min-height:400px;overflow:auto;padding:1rem}
    #preview svg{max-width:100%!important;height:auto!important}

    .neo-toast{position:fixed;top:1rem;right:1rem;z-index:100;padding:.85rem 1.1rem;border-radius:12px;color:#fff;font-weight:700;box-shadow:var(--shadow-l);transform:translateX(120%);transition:transform .25s ease}
    .neo-toast.success{background:linear-gradient(135deg,var(--accent),#16a34a)}
    .neo-toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .neo-toast.show{transform:translateX(0)}

    /* Tuiles export (claires, sans sous-titre) */
    .export-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem}
    .export-tile{
      display:flex;align-items:center;justify-content:center;
      height:72px;border:1px solid var(--surface-border);border-radius:16px;
      background:var(--surface-elevated);box-shadow:var(--shadow-s);
      font-family:'JetBrains Mono',monospace;font-weight:800;letter-spacing:.08em;
      font-size:1.15rem; text-transform:uppercase;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .export-tile:hover{transform:translateY(-1px);box-shadow:var(--shadow-m);background:#fff}

    @media (max-width:1280px){
      .container-main{grid-template-columns:1fr}
      .sidebar{order:2}
      .main-content{order:1}
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="toast" class="neo-toast"></div>

  <!-- Header -->
  <header class="modern-header sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <span class="brand-logo">enovacom pathway</span>
          <span class="brand-tagline">From idea to diagram in seconds</span>
        </div>
        <div class="flex items-center gap-3">
          <div x-data="{showDiagramMenu: false}" class="relative">
            <button @click="showDiagramMenu = !showDiagramMenu" class="neo-btn" title="Choisir un type de diagramme">
              üìä Diagramme
            </button>
            <div x-show="showDiagramMenu" @click.away="showDiagramMenu = false" x-cloak class="absolute top-full mt-2 right-0 bg-white border border-gray-200 rounded-xl shadow-xl p-2 z-50 min-w-[220px]">
              <button @click="loadDemoByType('flowchart'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üîÑ Flowchart</button>
              <button @click="loadDemoByType('sequence'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üí¨ Sequence</button>
              <button @click="loadDemoByType('class'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üì¶ Class</button>
              <button @click="loadDemoByType('state'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üîÄ State</button>
              <button @click="loadDemoByType('er'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üóÑÔ∏è ER Diagram</button>
              <button @click="loadDemoByType('gantt'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üìÖ Gantt</button>
              <button @click="loadDemoByType('pie'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">ü•ß Pie Chart</button>
              <button @click="loadDemoByType('gitgraph'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üå≥ Git Graph</button>
              <button @click="loadDemoByType('journey'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üó∫Ô∏è Journey</button>
            </div>
          </div>
          <button @click="showSettings = true" class="neo-btn" title="Param√®tres API">Param√®tres</button>
          <button @click="showHelp = true" class="neo-btn" title="Aide Mermaid">Aide</button>
        </div>
      </div>

      <!-- Choix du mod√®le -->
      <div class="flex items-center gap-6 mt-4 pt-4 border-t border-gray-200">
        <div class="flex items-center gap-3 flex-1">
          <label class="font-semibold">Mod√®le</label>
          <div x-show="loadingModels" class="text-gray-600">Chargement‚Ä¶</div>
          <select x-show="!loadingModels && models && models.length" x-model="selectedModel" class="neo-input neo-select flex-1 max-w-md" title="Mod√®le Mistral">
            <template x-for="(model, index) in models" :key="index">
              <option :value="model" x-text="model"></option>
            </template>
          </select>
          <div x-show="!loadingModels && (!models || !models.length)" class="text-sm text-red-600">Aucun mod√®le</div>
        </div>
        <button x-show="!loadingModels" @click="loadModels()" class="neo-btn neo-btn-icon" title="Recharger les mod√®les">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 4v6h-6"/><path d="M20.49 15A9 9 0 1 1 6 6.26"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="container-main space-y-6">
      <!-- Prompt IA - CENTR√â EN HAUT -->
      <section class="neo-card">
        <div class="neo-card-header" style="padding: 0.75rem 1rem;"><h2 class="section-title text-base">G√©n√©rer avec l'IA</h2></div>
        <div class="px-4 pb-4">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">
            <div class="lg:col-span-10">
              <textarea x-model="prompt" :class="['neo-input resize-none h-24 mb-0', isRecording ? 'ring-2 ring-rose-500' : '']" style="font-size: 0.9rem; padding: 0.6rem 0.8rem;" :placeholder="(isRecording ? 'Parlez‚Ä¶ la dict√©e est en cours üé§' : 'D√©crivez le diagramme que vous voulez cr√©er...')"></textarea>
            </div>
            <div class="lg:col-span-2 flex flex-col gap-2">
              <button @click="generate()" :disabled="loading || !prompt.trim()" class="neo-btn neo-btn-primary flex-1" style="min-height: 44px;" title="G√©n√©rer le diagramme (Ctrl+Enter)">
                <span x-show="!loading">‚ú® G√©n√©rer</span><span x-show="loading">‚è≥ G√©n√©ration‚Ä¶</span>
              </button>
              <button @click="toggleDictation()" class="neo-btn flex-1" :class="{'is-recording': isRecording}" :title="isRecording ? 'Arr√™ter la dict√©e' : 'Dicter'" aria-label="Dict√©e" style="min-height: 44px;">
                  üé§
                </button>
              </div>
            </div>
          </div>
          
          <!-- Historique des prompts -->
          <div x-show="promptHistory.length > 0" class="mt-3 pt-3 border-t border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-600">üìú Historique (10 derniers)</span>
              <button @click="clearHistory()" class="text-xs text-red-600 hover:text-red-700 font-medium">üóëÔ∏è Effacer</button>
            </div>
            <div class="flex flex-wrap gap-2">
              <template x-for="(p, index) in promptHistory" :key="index">
                <button @click="loadFromHistory(p)" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded border border-gray-300 transition-colors max-w-xs truncate" :title="p" x-text="p.substring(0, 50) + (p.length > 50 ? '...' : '')"></button>
              </template>
            </div>
          </div>
        </div>
      </section>

      <!-- √âditeur de code Mermaid -->
      <section class="neo-card">
        <div class="neo-card-header" style="padding: 0.75rem 1rem;"><h2 class="section-title text-base">√âditeur de code Mermaid</h2></div>
        <div class="px-4 pb-4">
          <textarea x-model="mermaidCode" @input="debouncedRender()" class="neo-input font-mono resize-vertical h-32 mb-3" style="font-size: 0.85rem; padding: 0.6rem 0.8rem;" placeholder="Tapez votre code Mermaid ici..."></textarea>
          <div class="text-xs">
            <span x-show="lastError" class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-red-50 text-red-700 border border-red-200">‚ùå <span x-text="lastError"></span></span>
            <span x-show="!lastError && mermaidCode" class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200">‚úÖ Syntaxe OK</span>
          </div>
        </div>
      </section>

        <!-- Toolbar ligne 1 : Th√®me + Couleurs -->
        <section class="bg-white/60 border border-gray-200 rounded-2xl p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4">
            <!-- Th√®me -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Th√®me</label>
              <select x-model="theme" @change="applyTheme()" class="neo-input neo-select" style="padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                <optgroup label="Professionnels">
                  <template x-for="t in availableThemes.filter(th => th.category === 'pro')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Sombres">
                  <template x-for="t in availableThemes.filter(th => th.category === 'dark')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Bleus">
                  <template x-for="t in availableThemes.filter(th => th.category === 'blue')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Verts">
                  <template x-for="t in availableThemes.filter(th => th.category === 'green')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Roses & Rouges">
                  <template x-for="t in availableThemes.filter(th => th.category === 'pink')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Violets">
                  <template x-for="t in availableThemes.filter(th => th.category === 'purple')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Chauds & Vifs">
                  <template x-for="t in availableThemes.filter(th => th.category === 'warm')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
              </select>
            </div>

            <!-- Couleur Bordure -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Bordure</label>
              <div class="flex items-center gap-2">
                <input type="color" x-model="borderColor" @input="updateColors()" class="w-10 h-8 border border-gray-300 rounded cursor-pointer" title="Couleur bordure"/>
                <select x-model="borderColor" @change="updateColors()" class="neo-input neo-select flex-1" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                  <optgroup label="Couleurs vives">
                    <option value="#EF4444">üî¥ Rouge</option>
                    <option value="#F97316">üü† Orange</option>
                    <option value="#F59E0B">üü° Ambre</option>
                    <option value="#EAB308">üü° Jaune</option>
                    <option value="#84CC16">üü¢ Citron</option>
                    <option value="#22C55E">üü¢ Vert</option>
                    <option value="#10B981">üü¢ √âmeraude</option>
                    <option value="#14B8A6">üîµ Turquoise</option>
                    <option value="#06B6D4">üîµ Cyan</option>
                    <option value="#0EA5E9">üîµ Bleu ciel</option>
                    <option value="#3B82F6">üîµ Bleu</option>
                    <option value="#6366F1">üü£ Indigo</option>
                    <option value="#8B5CF6">üü£ Violet</option>
                    <option value="#A855F7">üü£ Pourpre</option>
                    <option value="#D946EF">üü£ Fuchsia</option>
                    <option value="#EC4899">üî¥ Rose</option>
                  </optgroup>
                  <optgroup label="Couleurs professionnelles">
                    <option value="#0C4A45">üèõÔ∏è Enovacom</option>
                    <option value="#1E3A8A">üíº Bleu marine</option>
                    <option value="#1E40AF">üíº Bleu royal</option>
                    <option value="#7C3AED">üëë Violet pro</option>
                    <option value="#BE185D">üåπ Rose pro</option>
                    <option value="#9F1239">üç∑ Bordeaux</option>
                    <option value="#065F46">üå≤ For√™t</option>
                    <option value="#0F766E">üåä Oc√©an</option>
                  </optgroup>
                  <optgroup label="Couleurs neutres">
                    <option value="#6B7280">‚ö™ Gris</option>
                    <option value="#4B5563">‚ö´ Gris fonc√©</option>
                    <option value="#1F2937">‚ö´ Charbon</option>
                    <option value="#111827">‚ö´ Noir</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <!-- Couleur Remplissage -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Remplissage</label>
              <div class="flex items-center gap-2">
                <input type="color" x-model="fillColor" @input="updateColors()" class="w-10 h-8 border border-gray-300 rounded cursor-pointer" title="Couleur remplissage"/>
                <select x-model="fillColor" @change="updateColors()" class="neo-input neo-select flex-1" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                  <optgroup label="Couleurs vives">
                    <option value="#FEE2E2">üî¥ Rouge clair</option>
                    <option value="#FFEDD5">üü† Orange clair</option>
                    <option value="#FEF3C7">üü° Jaune clair</option>
                    <option value="#ECFCCB">üü¢ Citron clair</option>
                    <option value="#D1FAE5">üü¢ Vert clair</option>
                    <option value="#CCFBF1">üîµ Turquoise clair</option>
                    <option value="#DBEAFE">üîµ Bleu clair</option>
                    <option value="#E0E7FF">üü£ Indigo clair</option>
                    <option value="#EDE9FE">üü£ Violet clair</option>
                    <option value="#FCE7F3">üî¥ Rose clair</option>
                  </optgroup>
                  <optgroup label="Couleurs neutres">
                    <option value="#F9FAFB">‚ö™ Gris tr√®s clair</option>
                    <option value="#F3F4F6">‚ö™ Gris clair</option>
                    <option value="#E5E7EB">‚ö™ Gris moyen</option>
                    <option value="#FFFFFF">‚ö™ Blanc</option>
                  </optgroup>
                  <optgroup label="Couleurs professionnelles">
                    <option value="#E8F5F4">üîµ Bleu ciel</option>
                    <option value="#F1F5F9">üíº Graphite clair</option>
                    <option value="#F8FAFC">ü™® Ardoise clair</option>
                    <option value="#FEF9C3">üü° Jaune</option>
                    <option value="#ECFDF5">üíö √âmeraude clair</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <!-- Couleur Texte -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Texte</label>
              <div class="flex items-center gap-2">
                <input type="color" x-model="textColor" @input="updateColors()" class="w-10 h-8 border border-gray-300 rounded cursor-pointer" title="Couleur texte"/>
                <select x-model="textColor" @change="updateColors()" class="neo-input neo-select flex-1" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                  <optgroup label="Textes fonc√©s">
                    <option value="#111827">‚ö´ Noir</option>
                    <option value="#1F2937">‚ö´ Gris tr√®s fonc√©</option>
                    <option value="#374151">‚ö´ Gris fonc√©</option>
                    <option value="#4B5563">‚ö´ Gris moyen</option>
                  </optgroup>
                  <optgroup label="Textes clairs">
                    <option value="#F9FAFB">‚ö™ Blanc cass√©</option>
                    <option value="#FFFFFF">‚ö™ Blanc</option>
                    <option value="#E5E7EB">‚ö™ Gris clair</option>
                  </optgroup>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- Toolbar ligne 2 : Police et Taille -->
        <section class="bg-white/60 border border-gray-200 rounded-2xl p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Police -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Police</label>
              <select x-model="fontFamily" @change="onFontChange()" class="neo-input neo-select font-preview-select" style="padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                <optgroup label="Sans-serif modernes">
                  <option value="Inter, sans-serif" style="font-family: Inter, sans-serif;">Inter</option>
                  <option value="Roboto, sans-serif" style="font-family: Roboto, sans-serif;">Roboto</option>
                  <option value="'Open Sans', sans-serif" style="font-family: 'Open Sans', sans-serif;">Open Sans</option>
                  <option value="Lato, sans-serif" style="font-family: Lato, sans-serif;">Lato</option>
                  <option value="Poppins, sans-serif" style="font-family: Poppins, sans-serif;">Poppins</option>
                  <option value="Nunito, sans-serif" style="font-family: Nunito, sans-serif;">Nunito</option>
                  <option value="Raleway, sans-serif" style="font-family: Raleway, sans-serif;">Raleway</option>
                  <option value="Ubuntu, sans-serif" style="font-family: Ubuntu, sans-serif;">Ubuntu</option>
                </optgroup>
                <optgroup label="Design & Style">
                  <option value="'Work Sans', sans-serif" style="font-family: 'Work Sans', sans-serif;">Work Sans</option>
                  <option value="Manrope, sans-serif" style="font-family: Manrope, sans-serif;">Manrope</option>
                  <option value="Montserrat, sans-serif" style="font-family: Montserrat, sans-serif;">Montserrat</option>
                  <option value="Quicksand, sans-serif" style="font-family: Quicksand, sans-serif;">Quicksand</option>
                  <option value="Comfortaa, sans-serif" style="font-family: Comfortaa, sans-serif;">Comfortaa</option>
                  <option value="Bebas Neue, sans-serif" style="font-family: 'Bebas Neue', sans-serif;">Bebas Neue</option>
                  <option value="Oswald, sans-serif" style="font-family: Oswald, sans-serif;">Oswald</option>
                  <option value="Righteous, sans-serif" style="font-family: Righteous, sans-serif;">Righteous</option>
                </optgroup>
                <optgroup label="Professionnelles Modernes">
                  <option value="'DM Sans', sans-serif" style="font-family: 'DM Sans', sans-serif;">DM Sans</option>
                  <option value="'Plus Jakarta Sans', sans-serif" style="font-family: 'Plus Jakarta Sans', sans-serif;">Plus Jakarta Sans</option>
                  <option value="Sora, sans-serif" style="font-family: Sora, sans-serif;">Sora</option>
                  <option value="'Space Grotesk', sans-serif" style="font-family: 'Space Grotesk', sans-serif;">Space Grotesk</option>
                  <option value="Lexend, sans-serif" style="font-family: Lexend, sans-serif;">Lexend</option>
                  <option value="Outfit, sans-serif" style="font-family: Outfit, sans-serif;">Outfit</option>
                  <option value="Figtree, sans-serif" style="font-family: Figtree, sans-serif;">Figtree</option>
                  <option value="Archivo, sans-serif" style="font-family: Archivo, sans-serif;">Archivo</option>
                  <option value="Barlow, sans-serif" style="font-family: Barlow, sans-serif;">Barlow</option>
                  <option value="'Exo 2', sans-serif" style="font-family: 'Exo 2', sans-serif;">Exo 2</option>
                  <option value="Karla, sans-serif" style="font-family: Karla, sans-serif;">Karla</option>
                  <option value="'Red Hat Display', sans-serif" style="font-family: 'Red Hat Display', sans-serif;">Red Hat Display</option>
                </optgroup>
                <optgroup label="Serif (classique)">
                  <option value="'Playfair Display', serif" style="font-family: 'Playfair Display', serif;">Playfair Display</option>
                  <option value="Merriweather, serif" style="font-family: Merriweather, serif;">Merriweather</option>
                </optgroup>
                <optgroup label="Fantaisie & Fun">
                  <option value="Pacifico, cursive" style="font-family: Pacifico, cursive;">Pacifico</option>
                  <option value="Lobster, cursive" style="font-family: Lobster, cursive;">Lobster</option>
                  <option value="'Dancing Script', cursive" style="font-family: 'Dancing Script', cursive;">Dancing Script</option>
                  <option value="'Permanent Marker', cursive" style="font-family: 'Permanent Marker', cursive;">Permanent Marker</option>
                  <option value="'Indie Flower', cursive" style="font-family: 'Indie Flower', cursive;">Indie Flower</option>
                  <option value="'Shadows Into Light', cursive" style="font-family: 'Shadows Into Light', cursive;">Shadows Into Light</option>
                  <option value="Caveat, cursive" style="font-family: Caveat, cursive;">Caveat</option>
                </optgroup>
                <optgroup label="Monospace (code)">
                  <option value="'JetBrains Mono', monospace" style="font-family: 'JetBrains Mono', monospace;">JetBrains Mono</option>
                  <option value="'Source Code Pro', monospace" style="font-family: 'Source Code Pro', monospace;">Source Code Pro</option>
                  <option value="'Fira Code', monospace" style="font-family: 'Fira Code', monospace;">Fira Code</option>
                  <option value="'Courier Prime', monospace" style="font-family: 'Courier Prime', monospace;">Courier Prime</option>
                  <option value="'Space Mono', monospace" style="font-family: 'Space Mono', monospace;">Space Mono</option>
                </optgroup>
              </select>
            </div>

            <!-- Taille Police -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Taille Police</label>
              <div class="flex items-center gap-2">
                <input type="range" x-model="fontSize" @input="onFontChange()" min="10" max="28" step="1" class="flex-1" title="Ajuster la taille de police" />
                <span class="text-sm font-mono w-16 text-center font-semibold" x-text="fontSize + 'px'"></span>
              </div>
            </div>
          </div>
        </section>

        <!-- Toolbar ligne 3 : Exports -->
        <section class="bg-white/60 border border-gray-200 rounded-2xl p-4">
          <div class="flex items-center gap-4">
            <label class="font-semibold text-sm">Export</label>
            <div class="flex gap-2 flex-1">
              <button @click="exportSvg()" class="export-tile flex-1" style="height: 48px; font-size: 0.9rem;" aria-label="Exporter en SVG" title="Exporter en SVG">SVG</button>
              <button @click="exportPng()" class="export-tile flex-1" style="height: 48px; font-size: 0.9rem;" aria-label="Exporter en PNG (transparent)" title="Exporter en PNG">PNG</button>
              <button @click="exportJpeg()" class="export-tile flex-1" style="height: 48px; font-size: 0.9rem;" aria-label="Exporter en JPEG" title="Exporter en JPEG">JPEG</button>
            </div>
          </div>
        </section>

        <!-- Preview -->
        <section class="neo-card">
          <div class="neo-card-header"><h2 class="section-title">Aper√ßu</h2></div>
          <div class="px-6 pb-6">
            <div class="preview-container"><div id="preview" class="w-full min-h-[400px]"></div></div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Param√®tres -->
  <div x-show="showSettings" x-cloak class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showSettings = false">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-2xl max-w-md w-full p-8">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Param√®tres Mistral</h3>
        <button @click="showSettings = false" class="neo-btn neo-btn-icon" title="Fermer"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <form class="space-y-6" @submit.prevent>
        <div><label class="font-semibold block mb-2">Base URL</label><input x-model="settingsForm.base_url" type="url" class="neo-input" placeholder="https://api.mistral.ai" autocomplete="url"/></div>
        <div><label class="font-semibold block mb-2">API Key</label><input x-model="settingsForm.api_key" type="password" class="neo-input" placeholder="sk-..." autocomplete="new-password"/></div>
        <div class="flex gap-3 pt-4">
          <button @click="testMistralConnection()" class="neo-btn w-full">Tester</button>
          <button @click="saveMistralSettings()" class="neo-btn neo-btn-primary w-full">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Aide -->
  <div x-show="showHelp" x-cloak class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showHelp = false">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b p-6 rounded-t-2xl flex justify-between items-center" style="background: linear-gradient(135deg, #0C4A45 0%, #0f5650 100%);">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <div>
            <h3 class="text-2xl font-bold text-white">Guide Complet - Enovacom Pathway</h3>
            <p class="text-white/80 text-sm mt-1">Cr√©ez des diagrammes professionnels en quelques clics</p>
          </div>
        </div>
        <button @click="showHelp = false" class="neo-btn neo-btn-icon bg-white/20 hover:bg-white/30 text-white border-white/30" title="Fermer"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="p-8 space-y-10 text-sm text-gray-800">
  <!-- Intro -->
  <section class="space-y-3">
    <h3 class="text-xl font-bold">Guide rapide Mermaid</h3>
    <p>
      Mermaid transforme du texte en diagrammes. √âcris ton code dans l‚Äô√©diteur, l‚Äôaper√ßu se met √† jour.
      Tu peux ensuite exporter en <strong>SVG</strong>, <strong>PNG</strong> ou <strong>JPEG</strong>.
    </p>
    <ul class="list-disc pl-5 grid grid-cols-1 md:grid-cols-2 gap-1">
      <li><strong>Directions</strong> : <code>flowchart <span class="font-mono">TB</span>|<span class="font-mono">LR</span>|<span class="font-mono">RL</span>|<span class="font-mono">BT</span></code> (Top-Bottom, Left-Right, etc.).</li>
      <li><strong>Rendu</strong> : change le <em>Th√®me</em>, la <em>Couleur</em> et la <em>Police</em> pour un style coh√©rent.</li>
    </ul>
  </section>

  <!-- Flowchart -->
  <section class="space-y-3">
    <h4 class="text-lg font-semibold">1) Flowchart (processus)</h4>
    <p>Bo√Ætes, d√©cisions, √©tiquettes et styles de fl√®ches.</p>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>flowchart LR
  %% formes
  A[√âtape] --> B{D√©cision ?}
  B -- Oui --> C((OK))
  B -. Non .-> D[[Sous-proc√©d√©]]
  C ==> E[Fin]

  %% styles
  style C fill:#E8F5F4,stroke:#0C4A45,stroke-width:2px,color:#0e1f1c
  classDef accent fill:#FEE2E2,stroke:#DC2626,color:#991B1B,stroke-width:2px
  class D accent;
</code></pre>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">[Texte]</span> Rectangle</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">(Texte)</span> Coins arrondis</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">((Texte))</span> Cercle</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">{Texte}</span> Losange (d√©cision)</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">[[Texte]]</span> Sous-routine</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">[(Texte)]</span> Base de donn√©es</div>
    </div>
    <div>
      <p class="mb-2 font-medium">Fl√®ches & √©tiquettes (cheatsheet) :</p>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
        <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">A --&gt; B</span> fl√®che pleine</div>
        <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">A -.-> B</span> pointill√©e</div>
        <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">A ==&gt; B</span> √©paisse</div>
        <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">A -- Texte --&gt; B</span> label au milieu</div>
        <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">A --&gt;|Oui| B</span> label pr√®s de la fl√®che</div>
        <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">A --- B</span> simple trait (sans pointe)</div>
      </div>
    </div>
  </section>

  <!-- Sequence -->
  <section class="space-y-3">
    <h4 class="text-lg font-semibold">2) Sequence (√©changes)</h4>
    <p>Participants, messages, activations, conditions et notes.</p>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>sequenceDiagram
  autonumber
  participant P as Patient
  participant I as Infirmier
  participant M as M√©decin

  P -&gt;&gt; I: Arriv√©e
  I -&gt;&gt; M: Dossier
  activate M
  M --&gt;&gt; I: Instructions
  deactivate M

  Note over P,I: Accueil & triage

  alt Urgent
    I -&gt;&gt; M: Appel prioritaire
  else Standard
    I -&gt;&gt; P: Salle d'attente
  end
</code></pre>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">-&gt;&gt;</span> message synchrone</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">--&gt;&gt;</span> message asynchrone</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">activate / deactivate</span> activation de lifeline</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">Note over A,B</span> note</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">alt / else / end</span> branches</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">par / opt / loop</span> autres blocs</div>
    </div>
  </section>

  <!-- Class -->
  <section class="space-y-3">
    <h4 class="text-lg font-semibold">3) Class (mod√®le objet)</h4>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>classDiagram
  class Patient {
    +id: string
    +nom: string
    +admettre()
  }
  class Dossier {
    +id: string
    +etat: string
  }
  Patient "1" -- "1" Dossier : poss√®de
  Dossier &lt;|-- DossierUrgent : h√©rite
</code></pre>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">&lt;|--</span> h√©ritage</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">*--</span> composition</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">o--</span> agr√©gation</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">..&gt;</span> d√©pendance</div>
      <div><span class="font-mono bg-gray-100 px-2 py-1 rounded">--</span> association</div>
    </div>
  </section>

  <!-- State -->
  <section class="space-y-3">
    <h4 class="text-lg font-semibold">4) State (√©tats)</h4>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>stateDiagram-v2
  [*] --&gt; EnAttente
  EnAttente --&gt; EnCours: d√©clencher
  EnCours --&gt; Termin√©: finir
  state EnCours {
    [*] --&gt; Traitement
    Traitement --&gt; Validation
    Validation --&gt; [*]
  }
  Termin√© --&gt; [*]
</code></pre>
  </section>

  <!-- ER -->
  <section class="space-y-3">
    <h4 class="text-lg font-semibold">5) ER (entit√©s / relations)</h4>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>erDiagram
  PATIENT ||--o{ DOSSIER : poss√®de
  DOSSIER ||--o{ EXAMEN : comprend
  PATIENT {
    string id PK
    string nom
  }
  DOSSIER {
    string id PK
    string etat
  }
</code></pre>
    <p class="text-gray-600">Cardinalit√©s : <span class="font-mono">||</span>=1, <span class="font-mono">o</span>=0..1, <span class="font-mono">{</span>=0..n.</p>
  </section>

  <!-- Gantt & Pie -->
  <section class="space-y-3">
    <h4 class="text-lg font-semibold">6) Gantt (planning) &amp; Pie (r√©partition)</h4>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>gantt
  title Parcours patient
  dateFormat  YYYY-MM-DD
  section Accueil
  Admission       :a1, 2025-04-01, 1d
  Triage          :after a1, 1d
  section Soins
  Examens         :crit, 2d
  Diagnostic      :1d
</code></pre>
    <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>pie showData
  title R√©partition des actes
  "Consultation" : 40
  "Examens"      : 35
  "Urgences"     : 25
</code></pre>
  </section>

  <!-- Astuces -->
  <section class="space-y-2">
    <h4 class="text-lg font-semibold">Astuces</h4>
    <ul class="list-disc pl-5 space-y-1">
      <li><strong>Labels lisibles</strong> : utilise <span class="font-mono">|Texte|</span> sur les liens (<span class="font-mono">A --&gt;|Oui| B</span>).</li>
      <li><strong>Structurer</strong> : cr√©e des sous-graphes (clusters) avec <span class="font-mono">subgraph ‚Ä¶ end</span>.</li>
      <li><strong>Styles r√©utilisables</strong> : <span class="font-mono">classDef</span> puis <span class="font-mono">class id nomDeClasse;</span>.</li>
      <li><strong>D√©pannage</strong> : si ‚ÄúErreur Mermaid‚Äù, v√©rifie les accolades/parenth√®ses et les mots-cl√©s (ex. <span class="font-mono">stateDiagram-v2</span>).</li>
      <li><strong>Export</strong> : <span class="font-mono">SVG</span> (vectoriel), <span class="font-mono">PNG</span> (transparent), <span class="font-mono">JPEG</span> (bitmap fond blanc).</li>
    </ul>
  </section>
</div>

    </div>
  </div>

  <!-- App -->
  <script>
    function app(){
      return {
        prompt:'',
        promptHistory:[], // Historique des 10 derniers prompts
        mermaidCode:`sequenceDiagram
autonumber
participant Patient
participant GAMME as GAMME (Gestion Admission)
participant DPI as DPI (Dossier Patient Informatis√©)
Patient->>GAMME: ADT^A01 (Admission)
GAMME->>DPI: ADT^A01 (Cr√©ation dossier patient)
`,
        models:[], selectedModel:'', loading:false, loadingModels:false, lastError:'',
        showSettings:false, showHelp:false,

        // Visuels - VALEURS PAR D√âFAUT (Enovacom + Poppins)
        theme:'enovacom',
        primaryColor:'#0C4A45',
        fillColor:'#E8F5F4',      // Couleur de remplissage des √©l√©ments
        borderColor:'#0C4A45',     // Couleur des bordures
        textColor:'#0e1f1c',       // Couleur du texte
        fontFamily:"Poppins, sans-serif",  // Police par d√©faut : Poppins
        fontSize:16, // Taille par d√©faut plus lisible
        isRecording:false, recognition:null,

        // Th√®mes riches (couleur des bo√Ætes + fond canvas) - Organis√©s par cat√©gories
        availableThemes:[
          // Th√®mes Clairs Professionnels
          {id:'enovacom',name:'üèõÔ∏è Enovacom', stroke:'#0C4A45', boxBg:'#E8F5F4', boxBorder:'#0C4A45', boxText:'#0e1f1c', canvasBg:'#ffffff', category:'pro'},
          {id:'graphite',name:'üíº Graphite',  stroke:'#334155', boxBg:'#F1F5F9', boxBorder:'#334155', boxText:'#0F172A', canvasBg:'#ffffff', category:'pro'},
          {id:'neutral', name:'‚ö™ Neutre',    stroke:'#6B7280', boxBg:'#F9FAFB', boxBorder:'#6B7280', boxText:'#374151', canvasBg:'#ffffff', category:'pro'},
          {id:'ink',     name:'üñäÔ∏è Encre',     stroke:'#111827', boxBg:'#F3F4F6', boxBorder:'#111827', boxText:'#111827', canvasBg:'#ffffff', category:'pro'},
          {id:'slate',   name:'ü™® Ardoise',   stroke:'#475569', boxBg:'#F8FAFC', boxBorder:'#475569', boxText:'#1E293B', canvasBg:'#ffffff', category:'pro'},
          
          // Th√®mes Sombres
          {id:'midnight',name:'üåô Midnight',  stroke:'#8B5CF6', boxBg:'#1f2937', boxBorder:'#8B5CF6', boxText:'#F3F4F6', canvasBg:'#0F172A', dark:true, category:'dark'},
          {id:'darkblue',name:'üåå Bleu Nuit', stroke:'#3B82F6', boxBg:'#1E293B', boxBorder:'#3B82F6', boxText:'#E2E8F0', canvasBg:'#0F172A', dark:true, category:'dark'},
          {id:'carbon',  name:'‚ö´ Carbone',    stroke:'#10B981', boxBg:'#1F2937', boxBorder:'#10B981', boxText:'#F9FAFB', canvasBg:'#111827', dark:true, category:'dark'},
          {id:'purple',  name:'üíú Pourpre',   stroke:'#A855F7', boxBg:'#1E1B4B', boxBorder:'#A855F7', boxText:'#E9D5FF', canvasBg:'#0F0A1F', dark:true, category:'dark'},
          
          // Th√®mes Bleus & Verts
          {id:'ocean',   name:'üåä Oc√©an',     stroke:'#0EA5E9', boxBg:'#ECFEFF', boxBorder:'#0EA5E9', boxText:'#083344', canvasBg:'#F0FAFF', category:'blue'},
          {id:'cyan',    name:'üíé Cyan',      stroke:'#06B6D4', boxBg:'#ECFEFF', boxBorder:'#06B6D4', boxText:'#164E63', canvasBg:'#ffffff', category:'blue'},
          {id:'sky',     name:'‚òÅÔ∏è Ciel',       stroke:'#0284C7', boxBg:'#E0F2FE', boxBorder:'#0284C7', boxText:'#075985', canvasBg:'#F0F9FF', category:'blue'},
          {id:'emerald', name:'üíö √âmeraude',  stroke:'#10B981', boxBg:'#ECFDF5', boxBorder:'#10B981', boxText:'#064E3B', canvasBg:'#ffffff', category:'green'},
          {id:'forest',  name:'üå≤ For√™t',     stroke:'#065F46', boxBg:'#ECFDF5', boxBorder:'#065F46', boxText:'#064E3B', canvasBg:'#ffffff', category:'green'},
          {id:'lime',    name:'üçã Citron',     stroke:'#84CC16', boxBg:'#F7FEE7', boxBorder:'#84CC16', boxText:'#365314', canvasBg:'#ffffff', category:'green'},
          {id:'mint',    name:'üçÉ Menthe',     stroke:'#14B8A6', boxBg:'#F0FDFA', boxBorder:'#14B8A6', boxText:'#134E4A', canvasBg:'#ffffff', category:'green'},
          
          // Th√®mes Roses & Rouges - Couleurs plus vari√©es
          {id:'rose',    name:'üåπ Rose',       stroke:'#E11D48', boxBg:'#FFE4E6', boxBorder:'#E11D48', boxText:'#881337', canvasBg:'#ffffff', category:'pink'},
          {id:'pink',    name:'üíñ Fuchsia',    stroke:'#EC4899', boxBg:'#FCE7F3', boxBorder:'#EC4899', boxText:'#831843', canvasBg:'#ffffff', category:'pink'},
          {id:'magenta', name:'üíú Magenta',    stroke:'#D946EF', boxBg:'#FAE8FF', boxBorder:'#D946EF', boxText:'#701A75', canvasBg:'#ffffff', category:'pink'},
          
          // Th√®mes Violets
          {id:'violet',  name:'üíú Violet',    stroke:'#7C3AED', boxBg:'#F5F3FF', boxBorder:'#7C3AED', boxText:'#4C1D95', canvasBg:'#ffffff', category:'purple'},
          {id:'lavender',name:'ü™∑ Lavande',   stroke:'#8B5CF6', boxBg:'#F5F3FF', boxBorder:'#8B5CF6', boxText:'#4C1D95', canvasBg:'#ffffff', category:'purple'},
          {id:'indigo',  name:'üîµ Indigo',    stroke:'#6366F1', boxBg:'#EEF2FF', boxBorder:'#6366F1', boxText:'#312E81', canvasBg:'#ffffff', category:'purple'},
          
          // Th√®mes Chauds - Couleurs plus distinctes
          {id:'yellow',  name:'üü° Jaune',     stroke:'#EAB308', boxBg:'#FEF9C3', boxBorder:'#EAB308', boxText:'#713F12', canvasBg:'#ffffff', category:'warm'},
          {id:'amber',   name:'üü† Ambre',      stroke:'#F59E0B', boxBg:'#FEF3C7', boxBorder:'#F59E0B', boxText:'#78350F', canvasBg:'#ffffff', category:'warm'},
          {id:'orange',  name:'üçä Orange',    stroke:'#F97316', boxBg:'#FFEDD5', boxBorder:'#F97316', boxText:'#7C2D12', canvasBg:'#ffffff', category:'warm'},
          {id:'red',     name:'üî¥ Rouge',     stroke:'#DC2626', boxBg:'#FEE2E2', boxBorder:'#DC2626', boxText:'#7F1D1D', canvasBg:'#ffffff', category:'warm'},
          {id:'peach',   name:'üçë P√™che',     stroke:'#FB923C', boxBg:'#FFEDD5', boxBorder:'#FB923C', boxText:'#7C2D12', canvasBg:'#ffffff', category:'warm'}
        ],

        settingsForm:{ base_url:'https://api.mistral.ai', api_key:'' },
        renderTimeout:null,

        /* ---- Helpers couleurs ---- */
        mix(c1, c2, p){ // m√©lange 0..1
          try {
            // S√©curiser p entre 0 et 1
            p = Math.max(0, Math.min(1, Math.abs(p)));
            const a=this.hex2rgb(c1), b=this.hex2rgb(c2);
            const r=Math.max(0, Math.min(255, Math.round(a.r+(b.r-a.r)*p)));
            const g=Math.max(0, Math.min(255, Math.round(a.g+(b.g-a.g)*p)));
            const bl=Math.max(0, Math.min(255, Math.round(a.b+(b.b-a.b)*p)));
            return `#${[r,g,bl].map(x=>x.toString(16).padStart(2,'0')).join('')}`;
          } catch(e) {
            console.error('Mix error:', e, c1, c2, p);
            return c1; // Retourner la couleur d'origine en cas d'erreur
          }
        },
        hex2rgb(hex){ 
          try {
            const m=hex.replace('#',''); 
            return {
              r:parseInt(m.substr(0,2),16) || 0,
              g:parseInt(m.substr(2,2),16) || 0,
              b:parseInt(m.substr(4,2),16) || 0
            };
          } catch(e) {
            return {r:0, g:0, b:0};
          }
        },

        /* ---- Lifecycle ---- */
        init(){
          // Charger depuis localStorage
          this.loadFromStorage();
          
          // FORCER le th√®me Enovacom si c'est le th√®me s√©lectionn√©
          // Cela garantit que les couleurs correspondent bien au th√®me
          if(this.theme === 'enovacom') {
            this.applyTheme(); // Force les couleurs Enovacom
          }
          
          this.applyFontToPage();
          this.loadModels();
          this.initSpeech();
          this.renderMermaid();
          document.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); this.generate(); }});
        },

        loadFromStorage(){
          try {
            const c=localStorage;
            
            // V√©rifier si c'est le premier lancement
            const isFirstLaunch = !c.getItem('diagflow_theme');
            
            if(isFirstLaunch) {
              // PREMIER LANCEMENT : Forcer Enovacom + Poppins
              console.log('üéâ Premier lancement - Application des param√®tres par d√©faut : Enovacom + Poppins');
              this.theme = 'enovacom';
              this.fontFamily = 'Poppins, sans-serif';
              this.fontSize = 16;
              // Les couleurs seront appliqu√©es par applyTheme() dans init()
            } else {
              // Chargement normal depuis localStorage
              const code=c.getItem('diagflow_code'); if(code) this.mermaidCode=code;
              const theme=c.getItem('diagflow_theme'); if(theme) this.theme=theme;
              const borderColor=c.getItem('diagflow_borderColor'); if(borderColor) this.borderColor=borderColor;
              const fillColor=c.getItem('diagflow_fillColor'); if(fillColor) this.fillColor=fillColor;
              const textColor=c.getItem('diagflow_textColor'); if(textColor) this.textColor=textColor;
              const font=c.getItem('diagflow_font'); if(font) this.fontFamily=font;
              const size=c.getItem('diagflow_fontSize'); if(size) this.fontSize=parseInt(size);
              const model=c.getItem('diagflow_model'); if(model) this.selectedModel=model;
              const history=c.getItem('diagflow_history'); if(history) try{ this.promptHistory=JSON.parse(history); }catch(e){}
            }
          } catch(e) {
            console.error('Erreur chargement localStorage:', e);
            // En cas d'erreur, forcer les valeurs par d√©faut
            this.theme = 'enovacom';
            this.fontFamily = 'Poppins, sans-serif';
            this.fontSize = 16;
          }
        },
        saveToStorage(){
          try {
            const c=localStorage;
            c.setItem('diagflow_code', this.mermaidCode);
            c.setItem('diagflow_theme', this.theme);
            c.setItem('diagflow_borderColor', this.borderColor);
            c.setItem('diagflow_fillColor', this.fillColor);
            c.setItem('diagflow_textColor', this.textColor);
            c.setItem('diagflow_font', this.fontFamily);
            c.setItem('diagflow_fontSize', this.fontSize.toString());
            if(this.selectedModel) c.setItem('diagflow_model', this.selectedModel);
            c.setItem('diagflow_history', JSON.stringify(this.promptHistory));
          } catch(e) {
            console.error('Erreur sauvegarde localStorage:', e);
          }
        },

        async loadModels(){
          this.loadingModels=true; this.models=[]; this.selectedModel='';
          try{
            const r=await fetch('/api/mistral/models');
            if(r.ok){ const d=await r.json(); this.models=d.models||[]; this.selectedModel=this.models[0]||''; }
          }catch(e){ /* silencieux */ }
          finally{ this.loadingModels=false; this.saveToStorage(); }
        },

        debouncedRender(){ clearTimeout(this.renderTimeout); this.renderTimeout=setTimeout(()=>{ this.renderMermaid(); this.saveToStorage(); },250); },

        /* ---- Th√®me ---- */
        applyTheme(){
          const th=this.availableThemes.find(t=>t.id===this.theme);
          if(!th) return;
          
          // RESET COMPLET : Appliquer les couleurs du th√®me (√©crase les personnalisations)
          this.borderColor = th.boxBorder;
          this.fillColor = th.boxBg;
          this.textColor = th.boxText;
          
          console.log('Th√®me appliqu√©:', th.name, {
            borderColor: this.borderColor,
            fillColor: this.fillColor,
            textColor: this.textColor
          });

          // Recolor UI seulement pour Enovacom (branding)
          if(th.id==='enovacom'){
            const r=document.documentElement.style;
            r.setProperty('--primary', '#0C4A45'); r.setProperty('--primary-light', '#0f5650');
            r.setProperty('--primary-dark', '#083832'); r.setProperty('--accent', '#22c55e');
            r.setProperty('--accent-light', '#4ade80');
          }
          
          this.saveToStorage();
          
          // Forcer le re-render imm√©diat pour voir le changement
          this.renderMermaid();
        },
        onFontChange(){ 
          this.applyFontToPage(); 
          this.renderMermaid(); 
          this.saveToStorage(); 
        },
        applyFontToPage(){ 
          const preview=document.getElementById('preview'); 
          if(preview){ 
            preview.style.fontFamily = this.fontFamily;
            preview.style.setProperty('--app-font', this.fontFamily);
            // Appliquer aussi sur le SVG si pr√©sent
            const svg = preview.querySelector('svg');
            if(svg){
              svg.style.fontFamily = this.fontFamily;
              svg.querySelectorAll('*').forEach(el => {
                if(el.tagName === 'text' || el.tagName === 'tspan'){
                  el.style.fontFamily = this.fontFamily;
                }
              });
            }
          } 
        },
        updateColors(){ 
          // Ne pas re-rendre, juste sauvegarder et forcer un refresh
          this.saveToStorage();
          // Attendre un peu puis re-rendre
          setTimeout(() => this.renderMermaid(), 50);
        },

        /* ---- Rendu Mermaid avec couleurs de BO√éTES par th√®me ---- */
        async renderMermaid(){
          if(!this.mermaidCode.trim()){
            document.getElementById('preview').innerHTML='<div class="text-gray-400 text-center py-8">Aucun code √† afficher</div>'; return;
          }
          const th=this.availableThemes.find(t=>t.id===this.theme) || this.availableThemes[0];
          const isDark=!!th.dark;
          const cssFamily=this.fontFamily.replace(/"/g,"'");
          const edgeBg=isDark ? this.mix(th.canvasBg,'#000',.3) : '#ffffff';

          // Utiliser les couleurs personnalis√©es
          const strokeColor = this.borderColor || th.boxBorder;
          const fillBg = this.fillColor || th.boxBg;
          const textCol = this.textColor || th.boxText;
          
          // Calculer les couleurs d√©riv√©es de mani√®re s√©curis√©e
          const clusterFill = this.mix(fillBg, isDark ? '#000000' : '#ffffff', 0.15);
          const noteFill = this.mix(fillBg, isDark ? '#000000' : '#ffffff', 0.1);
          
          const themeCSS = `
            svg { 
              background:${th.canvasBg} !important; 
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* POLICE ET TAILLE - Forcer sur TOUS les √©l√©ments texte */
            text, tspan, .nodeLabel, .edgeLabel, .label, .messageText, .noteText,
            .actor text, .labelText, .titleText, .classText, .stateText,
            .er .entityLabel, .taskText, .sectionTitle, .gridLabel {
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Flowchart - TOUS les types de noeuds */
            .node rect, .node polygon, .node circle, .node ellipse, .node path { 
              fill:${fillBg} !important; 
              stroke:${strokeColor} !important; 
            }
            .node text, .nodeLabel { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Flowchart - Formes sp√©ciales (losanges, cercles, etc.) */
            .label-container rect, .label-container polygon, .label-container circle { 
              fill:${fillBg} !important; 
              stroke:${strokeColor} !important; 
            }
            
            /* Clusters / Subgraphs */
            .cluster rect, .cluster polygon { 
              fill:${clusterFill} !important; 
              stroke:${strokeColor} !important; 
            }
            .cluster text, .cluster .nodeLabel { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Edge labels & titles */
            .edgeLabel, .label { 
              color:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            .edgeLabel rect, .edgeLabel polygon { fill:${edgeBg} !important; }
            .edgeLabel text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Sequence diagram */
            .actor, .actor-box { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .actor rect, .actor polygon { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .actor text, .actor-man text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            .note { fill:${noteFill} !important; stroke:${strokeColor} !important; }
            .noteText, .messageText { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Class diagram */
            .classGroup rect { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .classGroup text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* State diagram */
            .stateGroup rect, .stateGroup circle { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .stateGroup text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* ER diagram */
            .er .entityBox { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .er .entityLabel { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            .er .attributeBoxEven, .er .attributeBoxOdd { fill:${fillBg} !important; }
            
            /* Gantt */
            .grid .tick { stroke:${strokeColor} !important; }
            .taskText { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
          `;

          try{
            mermaid.initialize({
              startOnLoad:false,
              securityLevel:'loose',
              theme: 'base',
              themeVariables:{
                fontFamily: cssFamily,
                fontSize: this.fontSize + 'px',
                
                // Couleurs principales
                primaryColor: fillBg,
                primaryBorderColor: strokeColor,
                primaryTextColor: textCol,
                
                // Lignes et bordures
                lineColor: strokeColor,
                border1: strokeColor,
                border2: strokeColor,
                
                // Backgrounds
                background: th.canvasBg,
                mainBkg: fillBg,
                secondBkg: fillBg,
                tertiaryColor: fillBg,
                
                // Clusters
                clusterBkg: clusterFill,
                clusterBorder: strokeColor,
                
                // Notes et labels
                noteBkgColor: noteFill,
                noteBorderColor: strokeColor,
                edgeLabelBackground: edgeBg,
                labelColor: textCol,
                
                // Sequence diagram
                actorBkg: fillBg,
                actorBorder: strokeColor,
                actorTextColor: textCol,
                actorLineColor: strokeColor,
                signalColor: strokeColor,
                signalTextColor: textCol,
                
                // Class diagram
                classText: textCol,
                
                // State diagram  
                labelBoxBkgColor: fillBg,
                labelBoxBorderColor: strokeColor,
                labelTextColor: textCol,
                
                // ER diagram
                attributeBackgroundColorOdd: fillBg,
                attributeBackgroundColorEven: fillBg
              },
              themeCSS
            });

            const preview=document.getElementById('preview');
            preview.innerHTML='';
            const { svg } = await mermaid.render('mermaid-diagram', this.mermaidCode);
            preview.innerHTML=svg;

            // FORCER la police et la taille sur TOUS les √©l√©ments texte
            const svgEl=preview.querySelector('svg');
            if(svgEl){ 
              svgEl.style.fontFamily=this.fontFamily; 
              svgEl.style.fontSize=this.fontSize+'px';
              
              // Forcer sur tous les √©l√©ments texte
              svgEl.querySelectorAll('text, tspan, .nodeLabel, .edgeLabel, .label, .messageText, .noteText, .actor text, .labelText, .titleText, .classText, .stateText, .taskText').forEach(el => {
                el.style.fontFamily = this.fontFamily;
                el.style.fontSize = this.fontSize + 'px';
              });
            }
            this.lastError='';
          }catch(err){
            this.lastError = err?.message || 'Erreur Mermaid';
            document.getElementById('preview').innerHTML = `<div class="text-red-600 text-center py-8">‚ùå ${this.lastError}</div>`;
          }
        },

        /* ---- Dict√©e ---- */
        initSpeech(){
          const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
          if(!Rec) return;
          this.recognition=new Rec(); this.recognition.continuous=true; this.recognition.interimResults=true; this.recognition.lang='fr-FR';
          this.recognition.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const t=e.results[i][0].transcript; if(e.results[i].isFinal) this.prompt=(this.prompt.trim()?this.prompt+' ':'')+t.trim(); } };
          this.recognition.onerror=()=>{ this.isRecording=false; }; this.recognition.onend=()=>{ this.isRecording=false; };
        },
        toggleDictation(){ if(!this.recognition){ this.showToast('Dict√©e non support√©e','error'); return; } this.isRecording?this.stopDictation():this.startDictation(); },
        startDictation(){ try{ this.recognition.start(); this.isRecording=true; this.showToast('Dict√©e d√©marr√©e','success'); }catch(e){ this.showToast('Impossible de d√©marrer la dict√©e','error'); } },
        stopDictation(){ try{ this.recognition.stop(); }catch(e){} this.isRecording=false; this.showToast('Dict√©e arr√™t√©e','success'); },

        /* ---- G√©n√©ration ---- */
        async generate(){
          if(!this.prompt.trim()){ this.showToast('Veuillez saisir un prompt','error'); return; }
          this.loading=true;
          try{
            const r=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:this.prompt,engine:'mistral',model:this.selectedModel})});
            const d=await r.json();
            if(r.ok){ 
              this.mermaidCode=d.mermaid; 
              this.addToHistory(this.prompt);
              this.renderMermaid(); 
              this.showToast('Diagramme g√©n√©r√© !','success'); 
            }
            else{ this.showToast(d.error||'Erreur lors de la g√©n√©ration','error'); }
          }catch(e){ this.showToast('Erreur r√©seau','error'); }
          finally{ this.loading=false; }
        },

        addToHistory(promptText){
          if(!promptText || !promptText.trim()) return;
          const text = promptText.trim();
          // √âviter les doublons
          this.promptHistory = this.promptHistory.filter(p => p !== text);
          // Ajouter au d√©but
          this.promptHistory.unshift(text);
          // Limiter √† 10
          if(this.promptHistory.length > 10) this.promptHistory = this.promptHistory.slice(0, 10);
          this.saveToStorage();
        },

        loadFromHistory(promptText){
          this.prompt = promptText;
          this.showToast('Prompt charg√© depuis l\'historique','success');
        },

        clearHistory(){
          if(confirm('Voulez-vous vraiment effacer tout l\'historique ?')){
            this.promptHistory = [];
            this.saveToStorage();
            this.showToast('Historique effac√©','success');
          }
        },

        loadDemoByType(type){
          const demoExamples = {
            flowchart: `flowchart LR
  A[Arriv√©e patient] --> B{Urgence ?}
  B -- Oui --> C((Triage prioritaire))
  B -. Non .-> D[Accueil standard]
  C ==> E[Consultation]
  D --> E`,
            sequence: `sequenceDiagram
  autonumber
  participant P as Patient
  participant I as Infirmier
  participant M as M√©decin

  P ->> I: Arriv√©e
  I ->> M: Dossier
  activate M
  M -->> I: Instructions
  deactivate M

  Note over P,I: Accueil & triage

  alt Urgent
    I ->> M: Appel prioritaire
  else Standard
    I ->> P: Salle d'attente
  end`,
            class: `classDiagram
  class Patient {
    +id: string
    +nom: string
    +admettre()
  }
  class Dossier {
    +id: string
    +etat: string
  }
  Patient "1" -- "1" Dossier : poss√®de
  Dossier <|-- DossierUrgent : h√©rite`,
            state: `stateDiagram-v2
  [*] --> EnAttente
  EnAttente --> EnCours: d√©clencher
  EnCours --> Termin√©: finir
  state EnCours {
    [*] --> Traitement
    Traitement --> Validation
    Validation --> [*]
  }
  Termin√© --> [*]`,
            er: `erDiagram
  PATIENT ||--o{ DOSSIER : a
  DOSSIER ||--o{ EXAMEN : contient
  PATIENT {
    string id PK
    string nom
  }
  DOSSIER {
    string id PK
    string etat
  }`,
            gantt: `gantt
  title Parcours patient
  dateFormat  YYYY-MM-DD
  section Accueil
  Admission       :a1, 2025-04-01, 1d
  Triage          :after a1, 1d
  section Soins
  Examens         :crit, 2d
  Diagnostic      :1d`,
            pie: `pie showData
  title R√©partition des actes m√©dicaux
  "Consultations" : 45
  "Examens" : 30
  "Urgences" : 15
  "Hospitalisations" : 10`,
            gitgraph: `gitGraph
  commit
  branch develop
  checkout develop
  commit
  commit
  checkout main
  merge develop
  commit
  branch feature
  checkout feature
  commit
  checkout main
  merge feature
  commit`,
            journey: `journey
  title Parcours Patient
  section Admission
    Accueil: 5: Patient
    Triage: 3: Infirmier
    Dossier: 2: Syst√®me
  section Consultation
    Examen: 4: M√©decin
    Diagnostic: 3: M√©decin
    Traitement: 5: √âquipe m√©dicale
  section Suivi
    Sortie: 2: Infirmier
    RDV Suivi: 1: Syst√®me`
          };
          
          this.mermaidCode = demoExamples[type] || demoExamples.flowchart;
          this.renderMermaid(); 
          this.showToast('D√©mo charg√©e !','success');
        },

        /* ---- Export fiable (toBlob) ---- */
        exportSvg(){
          const svg=document.querySelector('#preview svg');
          if(!svg){ this.showToast('Aucun diagramme √† exporter','error'); return; }
          const data=new XMLSerializer().serializeToString(svg);
          const blob=new Blob([data],{type:'image/svg+xml'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download='diagram.svg';
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          this.showToast('SVG t√©l√©charg√©','success');
        },
        async exportPng(scale=2){ await this.exportRaster('image/png','png',scale,1); },
        async exportJpeg(scale=2,quality=.92){ await this.exportRaster('image/jpeg','jpg',scale,quality); },

        async exportRaster(mime,ext,scale,quality){
          const svg=document.querySelector('#preview svg');
          if(!svg){ this.showToast('Aucun diagramme √† exporter','error'); return; }

          try{
            // Attendre que toutes les polices soient charg√©es
            if(document.fonts && document.fonts.ready){ 
              await document.fonts.ready; 
              // Petit d√©lai suppl√©mentaire pour s√©curiser le rendu
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          }catch(e){ console.warn('Font loading timeout:', e); }

          // Utiliser html2canvas ou une approche diff√©rente pour √©viter CORS
          // On va dessiner directement le SVG sans passer par une image interm√©diaire
          
          let w, h;
          const vb = svg.getAttribute('viewBox');
          if(vb){ 
            const p = vb.trim().split(/\s+/).map(Number); 
            w = p[2]; h = p[3]; 
          } else { 
            const bbox = svg.getBBox(); 
            w = bbox.width; h = bbox.height; 
          }
          w = Math.max(1, Math.floor(w));
          h = Math.max(1, Math.floor(h));

          const canvas = document.createElement('canvas');
          canvas.width = Math.round(w * scale);
          canvas.height = Math.round(h * scale);
          const ctx = canvas.getContext('2d');

          // Fond blanc pour JPEG
          if(mime === 'image/jpeg'){
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }

          // Cloner et pr√©parer le SVG
          const clone = svg.cloneNode(true);
          if(!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          clone.setAttribute('width', w);
          clone.setAttribute('height', h);
          
          // Forcer la police
          clone.style.fontFamily = this.fontFamily;
          clone.style.fontSize = this.fontSize + 'px';

          const svgStr = new XMLSerializer().serializeToString(clone);
          
          // CORRECTION CRITIQUE : Utiliser data URL au lieu de blob URL pour √©viter CORS
          const svgBase64 = btoa(unescape(encodeURIComponent(svgStr)));
          const url = `data:image/svg+xml;base64,${svgBase64}`;

          const img = new Image();
          img.onload = () => {
            ctx.setTransform(scale, 0, 0, scale, 0, 0);
            ctx.drawImage(img,0,0,w,h);

            canvas.toBlob((blob)=>{
              const outUrl=URL.createObjectURL(blob);
              const a=document.createElement('a'); a.href=outUrl; a.download=`diagram.${ext}`;
              document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(outUrl);
              URL.revokeObjectURL(url);
              this.showToast(`${ext.toUpperCase()} t√©l√©charg√©`,'success');
            }, mime, quality);
          };
          img.onerror=()=>{ URL.revokeObjectURL(url); this.showToast('Erreur export','error'); };
          img.src=url;
        },

        showToast(msg,type='success'){ const t=document.getElementById('toast'); t.textContent=msg; t.className=`neo-toast ${type} show`; setTimeout(()=>{ t.className=`neo-toast ${type}`; },2400); }
      }
    }
  </script>
</body>
</html>
