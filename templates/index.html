<!DOCTYPE html>
<html lang="fr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enovacom Pathway</title>

  <!-- Libs (en prod: Tailwind via CLI/PostCSS) -->
  <script src="https://unpkg.com/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.5.10/dist/typography.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  
  <!-- Quill.js - √âditeur WYSIWYG -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  
  <!-- Quill Table Module -->
  <link href="https://unpkg.com/quill-table@2/dist/quill-table.css" rel="stylesheet">
  <script src="https://unpkg.com/quill-table@2/dist/quill-table.js"></script>
  
  <!-- Marked.js - Conversion Markdown vers HTML (UMD global) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Webfonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@400;600;700&family=Work+Sans:wght@400;600;700&family=Manrope:wght@400;600;700&family=Montserrat:wght@500;700&family=JetBrains+Mono:wght@600;700&display=swap" />

  <style>
    [x-cloak]{display:none!important;}
    :root{
      /* Enovacom (sert aussi quand th√®me = Enovacom pour l'UI) */
      --primary:#0C4A45; --primary-light:#0f5650; --primary-dark:#083832;
      --accent:#22c55e; --accent-light:#4ade80;
      --surface:#ffffff; --surface-elevated:#fafafa; --surface-border:#e5e7eb;
      --text:#111827; --text-2:#6b7280; --muted:#9ca3af;
      --r-sm:10px; --r-md:14px; --r-lg:18px;
      --shadow-s:0 1px 3px 0 rgba(0,0,0,.08),0 1px 2px 0 rgba(0,0,0,.04);
      --shadow-m:0 5px 10px rgba(0,0,0,.06);
      --shadow-l:0 12px 24px rgba(0,0,0,.08);
    }
    *{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{background:linear-gradient(180deg,#fafafa 0%,#f3f4f6 100%);color:var(--text);-webkit-font-smoothing:antialiased}
    .modern-header{background:var(--surface);border-bottom:1px solid var(--surface-border);backdrop-filter:blur(10px);box-shadow:var(--shadow-s)}
    .brand-logo{font-weight:800;font-size:1.5rem;color:var(--primary);letter-spacing:-.02em}
    .brand-tagline{font-weight:500;font-size:.9rem;color:var(--text-2);margin-left:.5rem;padding-left:.5rem;border-left:2px solid var(--surface-border)}

    .neo-card{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--r-lg);box-shadow:var(--shadow-s);transition:transform .15s ease}
    .neo-card:hover{transform:translateY(-1px)}
    .neo-card-header{padding:1.1rem 1.1rem 0 1.1rem;border-bottom:1px solid var(--surface-border);margin-bottom:1.1rem}
    .section-title{font-weight:600;font-size:1.1rem}

    .neo-input{width:100%;padding:.8rem 1rem;border:1.5px solid var(--surface-border);border-radius:12px;background:var(--surface);font-weight:500}
    .neo-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(12,74,69,.12);outline:0}
    .neo-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .75rem center;background-size:1rem;padding-right:2.5rem}

    .neo-btn{display:inline-flex;align-items:center;justify-content:center;height:44px;padding:0 1rem;border-radius:12px;border:1px solid var(--surface-border);background:var(--surface-elevated);cursor:pointer}
    .neo-btn:hover{background:#fff;box-shadow:var(--shadow-s)}
    .neo-btn-primary{background:var(--primary);color:#fff;border:none}
    .neo-btn-primary:hover{background:var(--primary-light);box-shadow:var(--shadow-m)}
    .neo-btn-icon{width:44px;padding:0}
    .is-recording{background:rgba(242,101,80,.12);border-color:#f26950}

    .preview-container{background:var(--surface);border:1px solid var(--surface-border);border-radius:14px;min-height:400px;overflow:auto;padding:1rem}
    #preview svg{max-width:100%!important;height:auto!important}

    .neo-toast{position:fixed;top:1rem;right:1rem;z-index:100;padding:.85rem 1.1rem;border-radius:12px;color:#fff;font-weight:700;box-shadow:var(--shadow-l);transform:translateX(120%);transition:transform .25s ease}
    .neo-toast.success{background:linear-gradient(135deg,var(--accent),#16a34a)}
    .neo-toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .neo-toast.show{transform:translateX(0)}

    /* Tuiles export (claires, sans sous-titre) */
    .export-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem}
    .export-tile{
      display:flex;align-items:center;justify-content:center;
      height:72px;border:1px solid var(--surface-border);border-radius:16px;
      background:var(--surface-elevated);box-shadow:var(--shadow-s);
      font-family:'JetBrains Mono',monospace;font-weight:800;letter-spacing:.08em;
      font-size:1.15rem; text-transform:uppercase;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .export-tile:hover{transform:translateY(-1px);box-shadow:var(--shadow-m);background:#fff}

    @media (max-width:1280px){
      .container-main{grid-template-columns:1fr}
      .sidebar{order:2}
      .main-content{order:1}
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="toast" class="neo-toast"></div>

  <!-- Header -->
  <header class="modern-header sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <span class="brand-logo">enovacom pathway</span>
          <span class="brand-tagline">From idea to diagram in seconds</span>
        </div>
        <div class="flex items-center gap-3">
          <div x-data="{showDiagramMenu: false}" class="relative">
            <button @click="showDiagramMenu = !showDiagramMenu" class="neo-btn" title="Choisir un type de diagramme">
              D√©mo Diagramme
            </button>
            <div x-show="showDiagramMenu" @click.away="showDiagramMenu = false" x-cloak class="absolute top-full mt-2 right-0 bg-white border border-gray-200 rounded-xl shadow-xl p-2 z-50 min-w-[220px]">
              <button @click="loadDemoByType('flowchart'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üîÑ Flowchart</button>
              <button @click="loadDemoByType('sequence'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üí¨ Sequence</button>
              <button @click="loadDemoByType('class'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üì¶ Class</button>
              <button @click="loadDemoByType('state'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üîÄ State</button>
              <button @click="loadDemoByType('er'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üóÑÔ∏è ER Diagram</button>
              <button @click="loadDemoByType('gantt'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üìÖ Gantt</button>
              <button @click="loadDemoByType('pie'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">ü•ß Pie Chart</button>
              <button @click="loadDemoByType('gitgraph'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üå≥ Git Graph</button>
              <button @click="loadDemoByType('journey'); showDiagramMenu = false" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">üó∫Ô∏è Journey</button>
            </div>
          </div>
          <button @click="showSettings = true" class="neo-btn" title="Param√®tres API">Param√®tres</button>
          <button @click="showHelp = true" class="neo-btn" title="Aide Mermaid">Aide</button>
        </div>
      </div>

      <!-- Choix du mod√®le -->
      <div class="flex items-center gap-6 mt-4 pt-4 border-t border-gray-200">
        <div class="flex items-center gap-3 flex-1">
          <label class="font-semibold">Mod√®le</label>
          <div x-show="loadingModels" class="text-gray-600">Chargement‚Ä¶</div>
          <select x-show="!loadingModels && models && models.length" x-model="selectedModel" class="neo-input neo-select flex-1 max-w-md" title="Mod√®le Mistral">
            <template x-for="(model, index) in models" :key="index">
              <option :value="model" x-text="model"></option>
            </template>
          </select>
          <div x-show="!loadingModels && (!models || !models.length)" class="text-sm text-red-600">Aucun mod√®le</div>
        </div>
        <button x-show="!loadingModels" @click="loadModels()" class="neo-btn neo-btn-icon" title="Recharger les mod√®les">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 4v6h-6"/><path d="M20.49 15A9 9 0 1 1 6 6.26"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="container-main space-y-6">

      <!-- Section 1: Compte Rendu (d√©plac√© en premier) -->
      <section class="neo-card" id="compte-rendu">
        <div class="neo-card-header">
          <h2 class="section-title">Compte rendu</h2>
        </div>
        <div class="px-4 pb-4 space-y-4">
          <!-- Template + M√©tadonn√©es -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-semibold mb-1">Template</label>
              <select x-model="currentProject.report.template" class="neo-input neo-select">
                <template x-for="tpl in reportTemplates" :key="tpl.id">
                  <option :value="tpl.id" x-text="tpl.name"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Date r√©union</label>
              <input type="date" x-model="currentProject.report.meta.date" class="neo-input">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Participants</label>
              <input type="text" x-model="currentProject.report.meta.participants" class="neo-input" placeholder="Nom1, Nom2...">
            </div>
          </div>
          
          <!-- Notes brutes -->
          <div>
            <label class="block text-sm font-semibold mb-1">Notes brutes</label>
            <textarea x-model="currentProject.report.rawNotes" @input="saveProject()" class="neo-input resize-vertical h-32" placeholder="Tapez vos notes ici..."></textarea>
          </div>
          
          <!-- G√©n√©ration -->
          <div class="flex gap-2">
            <button @click="generateReport()" :disabled="isGeneratingReport || !currentProject.report.rawNotes.trim()" class="neo-btn neo-btn-primary flex-1">
              <span x-show="!isGeneratingReport">G√©n√©rer le compte rendu</span>
              <span x-show="isGeneratingReport">G√©n√©ration...</span>
            </button>
            <button @click="currentProject.report.generated = ''" :disabled="!currentProject.report.generated" class="neo-btn">R√©initialiser</button>
          </div>
          
          <!-- R√©sultat -->
          <div x-show="currentProject.report.generated" class="space-y-2">
            <label class="block text-sm font-semibold">Compte rendu g√©n√©r√© (√©ditable)</label>
            
            <!-- Barre d'outils √©diteur -->
            <div class="flex flex-wrap gap-2 mb-2">
              <button type="button" class="neo-btn" @click="format('bold')"><b>B</b></button>
              <button type="button" class="neo-btn" @click="format('italic')"><i>I</i></button>
              <button type="button" class="neo-btn" @click="format('underline')"><u>U</u></button>
              <button type="button" class="neo-btn" @click="format('strikeThrough')"><s>S</s></button>
              <div class="h-6 w-px bg-gray-300 mx-1"></div>
              <button type="button" class="neo-btn" @click="setHeading(1)">H1</button>
              <button type="button" class="neo-btn" @click="setHeading(2)">H2</button>
              <button type="button" class="neo-btn" @click="setHeading(3)">H3</button>
              <button type="button" class="neo-btn" @click="setHeading(4)">H4</button>
              <button type="button" class="neo-btn" @click="setHeading(5)">H5</button>
              <button type="button" class="neo-btn" @click="setHeading(6)">H6</button>
              <div class="h-6 w-px bg-gray-300 mx-1"></div>
              <button type="button" class="neo-btn" @click="format('insertUnorderedList')">‚Ä¢ Liste</button>
              <button type="button" class="neo-btn" @click="format('insertOrderedList')">1. Liste</button>
              <div class="h-6 w-px bg-gray-300 mx-1"></div>
              <button type="button" class="neo-btn" @click="format('justifyLeft')">‚Ü§</button>
              <button type="button" class="neo-btn" @click="format('justifyCenter')">‚Üî</button>
              <button type="button" class="neo-btn" @click="format('justifyRight')">‚Ü¶</button>
              <div class="h-6 w-px bg-gray-300 mx-1"></div>
              <button type="button" class="neo-btn" @click="undo()">‚Ü∂ Annuler</button>
              <button type="button" class="neo-btn" @click="redo()">‚Ü∑ R√©tablir</button>
              <div class="h-6 w-px bg-gray-300 mx-1"></div>
              <button type="button" class="neo-btn" @click="insertTable()">‚Üπ Tableau</button>
              <button type="button" class="neo-btn" @click="clearFormatting()">Effacer formatage</button>
            </div>

            <!-- √âditeur simple contenteditable avec styles CSS inline pour les tableaux -->
            <div 
              id="report-editor"
              contenteditable="true" 
              @input="currentProject.report.generated = $event.target.innerHTML; saveProject()"
              @keydown="onEditorKeydown($event)"
              x-html="currentProject.report.generated"
              class="neo-input min-h-[300px] p-4 overflow-auto"
              style="white-space: pre-wrap; line-height: 1.6;"
            ></div>
            
            <style>
              #report-editor table {
                width: 100%;
                border-collapse: collapse;
                margin: 16px 0;
              }
              #report-editor th {
                background-color: #0C4A45;
                color: white;
                padding: 12px;
                text-align: left;
                font-weight: bold;
                border: 1px solid #0C4A45;
              }
              #report-editor td {
                padding: 10px;
                border: 1px solid #d1d5db;
              }
              #report-editor tr:nth-child(even) {
                background-color: #f9fafb;
              }
              #report-editor h2 {
                font-size: 1.5em;
                font-weight: bold;
                margin-top: 24px;
                margin-bottom: 12px;
                color: #0C4A45;
              }
              #report-editor h3 {
                font-size: 1.25em;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 10px;
                color: #0C4A45;
              }
              #report-editor ul, #report-editor ol {
                margin: 12px 0;
                padding-left: 24px;
              }
              #report-editor li {
                margin: 6px 0;
              }
              #report-editor p {
                margin: 12px 0;
              }
              #report-editor strong {
                font-weight: bold;
                color: #0C4A45;
              }
            </style>
            
            <div class="flex gap-2 mt-2">
              <button @click="navigator.clipboard.writeText(document.getElementById('report-editor').innerText); showToast('Copi√©!', 'success')" class="neo-btn">Copier le texte</button>
              <button @click="currentProject.report.generated = ''; saveProject()" class="neo-btn">Effacer</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Prompt IA - plac√© sous le Compte Rendu -->
      <section class="neo-card">
        <div class="neo-card-header" style="padding: 0.75rem 1rem;"><h2 class="section-title text-base">G√©n√©rer avec l'IA</h2></div>
        <div class="px-4 pb-4">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">
            <div class="lg:col-span-10">
              <textarea x-model="prompt" :class="['neo-input resize-none h-24 mb-0', isRecording ? 'ring-2 ring-rose-500' : '']" style="font-size: 0.9rem; padding: 0.6rem 0.8rem;" :placeholder="(isRecording ? 'Parlez‚Ä¶ la dict√©e est en cours' : 'D√©crivez le diagramme que vous voulez cr√©er...')"></textarea>
            </div>
            <div class="lg:col-span-2 flex flex-col gap-2">
              <button @click="generate()" :disabled="loading || !prompt.trim()" class="neo-btn neo-btn-primary flex-1" style="min-height: 44px;" title="G√©n√©rer le diagramme (Ctrl+Enter)">
                <span x-show="!loading">G√©n√©rer</span><span x-show="loading">G√©n√©ration‚Ä¶</span>
              </button>
              <button @click="toggleDictation()" class="neo-btn flex-1" :class="{'is-recording': isRecording}" :title="isRecording ? 'Arr√™ter la dict√©e' : 'Dicter'" aria-label="Dict√©e" style="min-height: 44px;">Dicter</button>
            </div>
          </div>
          
          <!-- Historique des prompts -->
          <div x-show="promptHistory.length > 0" class="mt-3 pt-3 border-t border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-600">Historique (10 derniers)</span>
              <button @click="clearHistory()" class="text-xs text-red-600 hover:text-red-700 font-medium">Effacer</button>
            </div>
            <div class="flex flex-wrap gap-2">
              <template x-for="(p, index) in promptHistory" :key="index">
                <button @click="loadFromHistory(p)" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded border border-gray-300 transition-colors max-w-xs truncate" :title="p" x-text="p.substring(0, 50) + (p.length > 50 ? '...' : '')"></button>
              </template>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 2: Diagramme (d√©plac√© en deuxi√®me) -->
      <!-- √âditeur de code Mermaid -->
      <section class="neo-card">
        <div class="neo-card-header" style="padding: 0.75rem 1rem;"><h2 class="section-title text-base">√âditeur de code Mermaid</h2></div>
        <div class="px-4 pb-4 pt-2">
          <textarea x-model="mermaidCode" @input="debouncedRender()" class="neo-input font-mono resize-vertical h-32 mb-3" style="font-size: 0.85rem; padding: 0.6rem 0.8rem;" placeholder="Tapez votre code Mermaid ici..."></textarea>
          <div class="text-xs">
            <span x-show="lastError" class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-red-50 text-red-700 border border-red-200">‚ùå <span x-text="lastError"></span></span>
            <span x-show="!lastError && mermaidCode" class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200">‚úÖ Syntaxe OK</span>
          </div>
        </div>
      </section>

        <!-- Toolbar ligne 1 : Th√®me + Couleurs -->
        <section class="bg-white/60 border border-gray-200 rounded-2xl p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4">
            <!-- Th√®me -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Th√®me</label>
              <select x-model="theme" @change="applyTheme()" class="neo-input neo-select" style="padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                <optgroup label="Professionnels">
                  <template x-for="t in availableThemes.filter(th => th.category === 'pro')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Sombres">
                  <template x-for="t in availableThemes.filter(th => th.category === 'dark')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Bleus">
                  <template x-for="t in availableThemes.filter(th => th.category === 'blue')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Verts">
                  <template x-for="t in availableThemes.filter(th => th.category === 'green')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Roses & Rouges">
                  <template x-for="t in availableThemes.filter(th => th.category === 'pink')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Violets">
                  <template x-for="t in availableThemes.filter(th => th.category === 'purple')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
                <optgroup label="Chauds & Vifs">
                  <template x-for="t in availableThemes.filter(th => th.category === 'warm')" :key="t.id"><option :value="t.id" x-text="t.name"></option></template>
                </optgroup>
              </select>
            </div>

            <!-- Couleur Bordure -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Bordure</label>
              <div class="flex items-center gap-2">
                <input type="color" x-model="borderColor" @input="updateColors()" class="w-10 h-8 border border-gray-300 rounded cursor-pointer" title="Couleur bordure"/>
                <select x-model="borderColor" @change="updateColors()" class="neo-input neo-select flex-1" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                  <optgroup label="Couleurs vives">
                    <option value="#EF4444">üî¥ Rouge</option>
                    <option value="#F97316">üü† Orange</option>
                    <option value="#F59E0B">üü° Ambre</option>
                    <option value="#EAB308">üü° Jaune</option>
                    <option value="#84CC16">üü¢ Citron</option>
                    <option value="#22C55E">üü¢ Vert</option>
                    <option value="#10B981">üü¢ √âmeraude</option>
                    <option value="#14B8A6">üîµ Turquoise</option>
                    <option value="#06B6D4">üîµ Cyan</option>
                    <option value="#0EA5E9">üîµ Bleu ciel</option>
                    <option value="#3B82F6">üîµ Bleu</option>
                    <option value="#6366F1">üü£ Indigo</option>
                    <option value="#8B5CF6">üü£ Violet</option>
                    <option value="#A855F7">üü£ Pourpre</option>
                    <option value="#D946EF">üü£ Fuchsia</option>
                    <option value="#EC4899">üî¥ Rose</option>
                  </optgroup>
                  <optgroup label="Couleurs professionnelles">
                    <option value="#0C4A45">üèõÔ∏è Enovacom</option>
                    <option value="#1E3A8A">üíº Bleu marine</option>
                    <option value="#1E40AF">üíº Bleu royal</option>
                    <option value="#7C3AED">üëë Violet pro</option>
                    <option value="#BE185D">üåπ Rose pro</option>
                    <option value="#9F1239">üç∑ Bordeaux</option>
                    <option value="#065F46">üå≤ For√™t</option>
                    <option value="#0F766E">üåä Oc√©an</option>
                  </optgroup>
                  <optgroup label="Couleurs neutres">
                    <option value="#6B7280">‚ö™ Gris</option>
                    <option value="#4B5563">‚ö´ Gris fonc√©</option>
                    <option value="#1F2937">‚ö´ Charbon</option>
                    <option value="#111827">‚ö´ Noir</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <!-- Couleur Remplissage -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Remplissage</label>
              <div class="flex items-center gap-2">
                <input type="color" x-model="fillColor" @input="updateColors()" class="w-10 h-8 border border-gray-300 rounded cursor-pointer" title="Couleur remplissage"/>
                <select x-model="fillColor" @change="updateColors()" class="neo-input neo-select flex-1" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                  <optgroup label="Couleurs vives">
                    <option value="#FEE2E2">üî¥ Rouge clair</option>
                    <option value="#FFEDD5">üü† Orange clair</option>
                    <option value="#FEF3C7">üü° Jaune clair</option>
                    <option value="#ECFCCB">üü¢ Citron clair</option>
                    <option value="#D1FAE5">üü¢ Vert clair</option>
                    <option value="#CCFBF1">üîµ Turquoise clair</option>
                    <option value="#DBEAFE">üîµ Bleu clair</option>
                    <option value="#E0E7FF">üü£ Indigo clair</option>
                    <option value="#EDE9FE">üü£ Violet clair</option>
                    <option value="#FCE7F3">üî¥ Rose clair</option>
                  </optgroup>
                  <optgroup label="Couleurs neutres">
                    <option value="#F9FAFB">‚ö™ Gris tr√®s clair</option>
                    <option value="#F3F4F6">‚ö™ Gris clair</option>
                    <option value="#E5E7EB">‚ö™ Gris moyen</option>
                    <option value="#FFFFFF">‚ö™ Blanc</option>
                  </optgroup>
                  <optgroup label="Couleurs professionnelles">
                    <option value="#E8F5F4">üîµ Bleu ciel</option>
                    <option value="#F1F5F9">üíº Graphite clair</option>
                    <option value="#F8FAFC">ü™® Ardoise clair</option>
                    <option value="#FEF9C3">üü° Jaune</option>
                    <option value="#ECFDF5">üíö √âmeraude clair</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <!-- Couleur Texte -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Texte</label>
              <div class="flex items-center gap-2">
                <input type="color" x-model="textColor" @input="updateColors()" class="w-10 h-8 border border-gray-300 rounded cursor-pointer" title="Couleur texte"/>
                <select x-model="textColor" @change="updateColors()" class="neo-input neo-select flex-1" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                  <optgroup label="Textes fonc√©s">
                    <option value="#111827">‚ö´ Noir</option>
                    <option value="#1F2937">‚ö´ Gris tr√®s fonc√©</option>
                    <option value="#374151">‚ö´ Gris fonc√©</option>
                    <option value="#4B5563">‚ö´ Gris moyen</option>
                  </optgroup>
                  <optgroup label="Textes clairs">
                    <option value="#F9FAFB">‚ö™ Blanc cass√©</option>
                    <option value="#FFFFFF">‚ö™ Blanc</option>
                    <option value="#E5E7EB">‚ö™ Gris clair</option>
                  </optgroup>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- Toolbar ligne 2 : Police et Taille -->
        <section class="bg-white/60 border border-gray-200 rounded-2xl p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Police -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Police</label>
              <select x-model="fontFamily" @change="onFontChange()" class="neo-input neo-select font-preview-select" style="padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                <optgroup label="Sans-serif modernes">
                  <option value="Inter, sans-serif" style="font-family: Inter, sans-serif;">Inter</option>
                  <option value="Roboto, sans-serif" style="font-family: Roboto, sans-serif;">Roboto</option>
                  <option value="'Open Sans', sans-serif" style="font-family: 'Open Sans', sans-serif;">Open Sans</option>
                  <option value="Lato, sans-serif" style="font-family: Lato, sans-serif;">Lato</option>
                  <option value="Poppins, sans-serif" style="font-family: Poppins, sans-serif;">Poppins</option>
                  <option value="Nunito, sans-serif" style="font-family: Nunito, sans-serif;">Nunito</option>
                  <option value="Raleway, sans-serif" style="font-family: Raleway, sans-serif;">Raleway</option>
                  <option value="Ubuntu, sans-serif" style="font-family: Ubuntu, sans-serif;">Ubuntu</option>
                </optgroup>
                <optgroup label="Design & Style">
                  <option value="'Work Sans', sans-serif" style="font-family: 'Work Sans', sans-serif;">Work Sans</option>
                  <option value="Manrope, sans-serif" style="font-family: Manrope, sans-serif;">Manrope</option>
                  <option value="Montserrat, sans-serif" style="font-family: Montserrat, sans-serif;">Montserrat</option>
                  <option value="Quicksand, sans-serif" style="font-family: Quicksand, sans-serif;">Quicksand</option>
                  <option value="Comfortaa, sans-serif" style="font-family: Comfortaa, sans-serif;">Comfortaa</option>
                  <option value="Bebas Neue, sans-serif" style="font-family: 'Bebas Neue', sans-serif;">Bebas Neue</option>
                  <option value="Oswald, sans-serif" style="font-family: Oswald, sans-serif;">Oswald</option>
                  <option value="Righteous, sans-serif" style="font-family: Righteous, sans-serif;">Righteous</option>
                </optgroup>
                <optgroup label="Professionnelles Modernes">
                  <option value="'DM Sans', sans-serif" style="font-family: 'DM Sans', sans-serif;">DM Sans</option>
                  <option value="'Plus Jakarta Sans', sans-serif" style="font-family: 'Plus Jakarta Sans', sans-serif;">Plus Jakarta Sans</option>
                  <option value="Sora, sans-serif" style="font-family: Sora, sans-serif;">Sora</option>
                  <option value="'Space Grotesk', sans-serif" style="font-family: 'Space Grotesk', sans-serif;">Space Grotesk</option>
                  <option value="Lexend, sans-serif" style="font-family: Lexend, sans-serif;">Lexend</option>
                  <option value="Outfit, sans-serif" style="font-family: Outfit, sans-serif;">Outfit</option>
                  <option value="Figtree, sans-serif" style="font-family: Figtree, sans-serif;">Figtree</option>
                  <option value="Archivo, sans-serif" style="font-family: Archivo, sans-serif;">Archivo</option>
                  <option value="Barlow, sans-serif" style="font-family: Barlow, sans-serif;">Barlow</option>
                  <option value="'Exo 2', sans-serif" style="font-family: 'Exo 2', sans-serif;">Exo 2</option>
                  <option value="Karla, sans-serif" style="font-family: Karla, sans-serif;">Karla</option>
                  <option value="'Red Hat Display', sans-serif" style="font-family: 'Red Hat Display', sans-serif;">Red Hat Display</option>
                </optgroup>
                <optgroup label="Serif (classique)">
                  <option value="'Playfair Display', serif" style="font-family: 'Playfair Display', serif;">Playfair Display</option>
                  <option value="Merriweather, serif" style="font-family: Merriweather, serif;">Merriweather</option>
                </optgroup>
                <optgroup label="Fantaisie & Fun">
                  <option value="Pacifico, cursive" style="font-family: Pacifico, cursive;">Pacifico</option>
                  <option value="Lobster, cursive" style="font-family: Lobster, cursive;">Lobster</option>
                  <option value="'Dancing Script', cursive" style="font-family: 'Dancing Script', cursive;">Dancing Script</option>
                  <option value="'Permanent Marker', cursive" style="font-family: 'Permanent Marker', cursive;">Permanent Marker</option>
                  <option value="'Indie Flower', cursive" style="font-family: 'Indie Flower', cursive;">Indie Flower</option>
                  <option value="'Shadows Into Light', cursive" style="font-family: 'Shadows Into Light', cursive;">Shadows Into Light</option>
                  <option value="Caveat, cursive" style="font-family: Caveat, cursive;">Caveat</option>
                </optgroup>
                <optgroup label="Monospace (code)">
                  <option value="'JetBrains Mono', monospace" style="font-family: 'JetBrains Mono', monospace;">JetBrains Mono</option>
                  <option value="'Source Code Pro', monospace" style="font-family: 'Source Code Pro', monospace;">Source Code Pro</option>
                  <option value="'Fira Code', monospace" style="font-family: 'Fira Code', monospace;">Fira Code</option>
                  <option value="'Courier Prime', monospace" style="font-family: 'Courier Prime', monospace;">Courier Prime</option>
                  <option value="'Space Mono', monospace" style="font-family: 'Space Mono', monospace;">Space Mono</option>
                </optgroup>
              </select>
            </div>

            <!-- Taille Police -->
            <div>
              <label class="font-semibold block mb-1 text-sm">Taille Police</label>
              <div class="flex items-center gap-2">
                <input type="range" x-model="fontSize" @input="onFontChange()" min="10" max="28" step="1" class="flex-1" title="Ajuster la taille de police" />
                <span class="text-sm font-mono w-16 text-center font-semibold" x-text="fontSize + 'px'"></span>
              </div>
            </div>
          </div>
        </section>

        <!-- Toolbar ligne 3 : Exports -->
        <section class="bg-white/60 border border-gray-200 rounded-2xl p-4">
          <div class="flex items-center gap-4">
            <label class="font-semibold text-sm">Export</label>
            <div class="flex gap-2 flex-1">
              <button @click="exportSvg()" class="export-tile flex-1" style="height: 48px; font-size: 0.9rem;" aria-label="Exporter en SVG" title="Exporter en SVG">SVG</button>
              <button @click="exportPng()" class="export-tile flex-1" style="height: 48px; font-size: 0.9rem;" aria-label="Exporter en PNG (transparent)" title="Exporter en PNG">PNG</button>
              <button @click="exportJpeg()" class="export-tile flex-1" style="height: 48px; font-size: 0.9rem;" aria-label="Exporter en JPEG" title="Exporter en JPEG">JPEG</button>
            </div>
          </div>
        </section>

        <!-- Preview -->
        <section class="neo-card">
          <div class="neo-card-header"><h2 class="section-title">Aper√ßu</h2></div>
          <div class="px-6 pb-6">
            <div class="preview-container"><div id="preview" class="w-full min-h-[400px]"></div></div>
          </div>
        </section>
      </div>
      
      <!-- Section 3: Images -->
      <section class="neo-card" id="images">
        <div class="neo-card-header">
          <h2 class="section-title">Images</h2>
        </div>
        <div class="px-4 pb-4 space-y-4">
          <!-- Zone upload -->
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
            <input type="file" id="imageUpload" @change="addImage($event)" accept="image/jpeg,image/png" multiple class="hidden">
            <label for="imageUpload" class="cursor-pointer">
              <div class="text-sm font-semibold">Cliquez pour ajouter des images</div>
              <div class="text-xs text-gray-500 mt-1">JPEG/PNG ‚Ä¢ Max 2 Mo/image ‚Ä¢ Max 10 images</div>
            </label>
          </div>
          
          <!-- Galerie -->
          <div x-show="currentProject.images.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <template x-for="(img, idx) in currentProject.images" :key="img.id">
              <div class="border border-gray-200 rounded-lg p-2 space-y-2">
                <div class="relative">
                  <img :src="img.dataUrl" :alt="img.name" class="w-full h-32 object-cover rounded">
                  <div class="absolute top-1 right-1 flex gap-1">
                    <button @click="moveImageUp(idx)" :disabled="idx === 0" class="bg-white rounded px-2 py-1 text-xs shadow hover:bg-gray-100" title="Monter">‚¨ÜÔ∏è</button>
                    <button @click="moveImageDown(idx)" :disabled="idx === currentProject.images.length - 1" class="bg-white rounded px-2 py-1 text-xs shadow hover:bg-gray-100" title="Descendre">‚¨áÔ∏è</button>
                  </div>
                </div>
                <input type="text" x-model="img.caption" class="neo-input text-xs" placeholder="L√©gende...">
                <button @click="removeImage(img.id)" class="neo-btn text-xs w-full">üóëÔ∏è Supprimer</button>
              </div>
            </template>
          </div>
          
          <div x-show="currentProject.images.length === 0" class="text-center text-gray-500 text-sm py-4">
            Aucune image ajout√©e
          </div>
        </div>
      </section>
      
      <!-- Section 4: PDF -->
      <section class="neo-card" id="pdf">
        <div class="neo-card-header">
          <h2 class="section-title">üìÑ Export PDF</h2>
        </div>
        <div class="px-4 pb-4 space-y-4">
          <!-- En-t√™te du document -->
          <div class="border-b pb-3 mb-3">
            <h3 class="text-lg font-semibold mb-3">En-t√™te du document</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-semibold mb-1">Titre du document (nom du projet)</label>
                <input type="text" x-model="currentProject.pdfConfig.title" @input="currentProject.name = currentProject.pdfConfig.title" class="neo-input" placeholder="Document">
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Client</label>
                <input type="text" x-model="currentProject.pdfConfig.client" class="neo-input" placeholder="Nom du client">
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Sous-titre / Version</label>
                <input type="text" x-model="currentProject.pdfConfig.subtitle" class="neo-input" placeholder="v1.0">
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Logo</label>
                <input type="file" @change="uploadLogo($event)" accept="image/png,image/jpeg" class="hidden" id="logoUpload">
                <div class="flex gap-2">
                  <button @click="document.getElementById('logoUpload').click()" type="button" class="neo-btn">Choisir un fichier</button>
                  <button @click="setDefaultLogo()" type="button" class="neo-btn">Logo Enovacom</button>
                  <button @click="currentProject.pdfConfig.logo = ''" type="button" class="neo-btn" :disabled="!currentProject.pdfConfig.logo">Retirer</button>
                </div>
                <div x-show="currentProject.pdfConfig.logo" class="mt-2">
                  <img :src="currentProject.pdfConfig.logo" alt="Logo" class="h-12 border border-gray-300 rounded">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Pied de page -->
          <div class="border-b pb-3 mb-3">
            <h3 class="text-lg font-semibold mb-3">Pied de page</h3>
            <div class="grid grid-cols-1 gap-3">
              <div>
                <label class="block text-sm font-semibold mb-1">Mentions l√©gales</label>
                <input type="text" x-model="currentProject.pdfConfig.legal" class="neo-input" placeholder="ENOVACOM - Tous droits r√©serv√©s">
              </div>
              <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" x-model="currentProject.pdfConfig.watermark" class="w-4 h-4">
                  <span class="text-sm font-semibold">Watermark "CONFIDENTIEL"</span>
                </label>
              </div>
            </div>
          </div>
          
          
          
          <!-- Bouton g√©n√©ration -->
          <button @click="generatePDF()" :disabled="isGeneratingPDF" class="neo-btn neo-btn-primary w-full md:w-auto">
            <span x-show="!isGeneratingPDF">T√©l√©charger le PDF</span>
            <span x-show="isGeneratingPDF">G√©n√©ration PDF...</span>
          </button>
        </div>
      </section>
      
      <!-- Section 5: Historique des projets -->
      <section class="neo-card" id="historique">
        <div class="neo-card-header flex items-center justify-between">
          <h2 class="section-title">Historique des projets</h2>
          <button x-show="projects.length > 0" @click="clearAllProjects()" class="text-sm text-red-600 hover:text-red-700 font-medium px-3 py-1 rounded hover:bg-red-50 transition">
            Tout effacer
          </button>
        </div>
        <div class="px-4 pb-4">
          <div x-show="projects.length > 0" class="space-y-2">
            <template x-for="project in projects" :key="project.id">
              <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between hover:bg-gray-50">
                <div class="flex-1">
                  <div class="font-semibold" x-text="project.name || project.pdfConfig?.title || 'Sans titre'"></div>
                  <div class="text-xs text-gray-500" x-text="new Date(project.updatedAt).toLocaleString('fr-FR')"></div>
                </div>
                <div class="flex gap-2">
                  <button @click="loadProject(project.id)" class="neo-btn text-xs">Ouvrir</button>
                  <button @click="deleteProject(project.id)" class="neo-btn text-xs">Supprimer</button>
                </div>
              </div>
            </template>
          </div>
          
          <div x-show="projects.length === 0" class="text-center text-gray-500 text-sm py-4">
            Aucun projet sauvegard√©
          </div>
        </div>
      </section>
      
    </div>
  </main>

  <!-- Param√®tres -->
  <div x-show="showSettings" x-cloak class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showSettings = false">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-2xl max-w-md w-full p-8">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Param√®tres Mistral</h3>
        <button @click="showSettings = false" class="neo-btn neo-btn-icon" title="Fermer"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <form class="space-y-6" @submit.prevent>
        <div><label class="font-semibold block mb-2">Base URL</label><input x-model="settingsForm.base_url" type="url" class="neo-input" placeholder="https://api.mistral.ai" autocomplete="url"/></div>
        <div><label class="font-semibold block mb-2">API Key</label><input x-model="settingsForm.api_key" type="password" class="neo-input" placeholder="sk-..." autocomplete="new-password"/></div>
        <div class="flex gap-3 pt-4">
          <button @click="testMistralConnection()" class="neo-btn w-full">Tester</button>
          <button @click="saveMistralSettings()" class="neo-btn neo-btn-primary w-full">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Aide -->
  <div x-show="showHelp" x-cloak class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showHelp = false">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b p-6 rounded-t-2xl flex justify-between items-center" style="background: linear-gradient(135deg, #0C4A45 0%, #0f5650 100%);">
        <div>
          <h3 class="text-2xl font-bold text-white">Guide Complet - Enovacom Pathway</h3>
          <p class="text-white/80 text-sm mt-1">Cr√©ez des diagrammes professionnels en quelques clics</p>
        </div>
        <button @click="showHelp = false" class="neo-btn neo-btn-icon bg-white/20 hover:bg-white/30 text-white border-white/30" title="Fermer"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="p-8 space-y-8 text-sm text-gray-800">

  <!-- D√©marrage rapide -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">D√©marrage rapide</h3>
    <p class="text-base">Enovacom Pathway transforme vos id√©es en diagrammes professionnels en quelques secondes gr√¢ce √† l'IA.</p>
    
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mt-4">
      <h4 class="font-bold text-base mb-2">3 fa√ßons de cr√©er un diagramme</h4>
      <ol class="list-decimal pl-5 space-y-1">
        <li><strong>Avec l'IA</strong> : D√©crivez votre diagramme en fran√ßais dans la zone de texte et cliquez sur "G√©n√©rer"</li>
        <li><strong>Par dict√©e vocale</strong> : Cliquez sur üé§ et parlez, l'IA comprendra votre demande</li>
        <li><strong>Manuellement</strong> : √âcrivez directement le code Mermaid dans l'√©diteur</li>
      </ol>
    </div>
  </section>

  <!-- Exemples de prompts IA -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">Exemples de prompts IA</h3>
    
    <div class="bg-amber-50 border-l-4 border-amber-500 p-4">
      <p class="font-bold text-base mb-2">‚ö†Ô∏è Important : Pr√©cisez toujours le type de diagramme au d√©but de votre prompt !</p>
    </div>

    <div class="space-y-3 mt-4">
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
        <h5 class="font-bold mb-2">Pour un Flowchart :</h5>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li><code class="bg-white px-2 py-1 rounded border">Flowchart : Cr√©e un diagramme du processus d'admission d'un patient √† l'h√¥pital</code></li>
          <li><code class="bg-white px-2 py-1 rounded border">Flowchart : Montre-moi le workflow de validation d'une ordonnance</code></li>
        </ul>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
        <h5 class="font-bold mb-2">Pour un diagramme de S√©quence :</h5>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li><code class="bg-white px-2 py-1 rounded border">Sequence : Diagramme des √©changes entre patient, infirmier et m√©decin lors d'une consultation</code></li>
          <li><code class="bg-white px-2 py-1 rounded border">Sequence : Interactions entre le syst√®me de prescription et la pharmacie</code></li>
        </ul>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
        <h5 class="font-bold mb-2">Pour un diagramme de Classes :</h5>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li><code class="bg-white px-2 py-1 rounded border">Class : Mod√©lise les entit√©s Patient, M√©decin, Consultation et Ordonnance</code></li>
        </ul>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
        <h5 class="font-bold mb-2">Pour un diagramme d'√âtats :</h5>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li><code class="bg-white px-2 py-1 rounded border">State : √âtats d'une demande d'examen m√©dical de la cr√©ation √† l'archivage</code></li>
        </ul>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
        <h5 class="font-bold mb-2">Autres types :</h5>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li><code class="bg-white px-2 py-1 rounded border">ER : Relations entre Patient, M√©decin, Consultation et Ordonnance</code></li>
          <li><code class="bg-white px-2 py-1 rounded border">Gantt : Planning d'un projet de d√©ploiement sur 6 mois</code></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Personnalisation -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">Personnalisation</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <h5 class="font-bold mb-2">üé® Th√®mes</h5>
        <p>Choisissez parmi 30+ th√®mes professionnels class√©s par cat√©gorie (Pro, Sombres, Bleus, Verts, etc.)</p>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <h5 class="font-bold mb-2">üé® Couleurs</h5>
        <ul class="list-disc pl-5 space-y-1">
          <li><strong>Bordure</strong> : Couleur des contours</li>
          <li><strong>Remplissage</strong> : Couleur de fond</li>
          <li><strong>Texte</strong> : Couleur du texte</li>
        </ul>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <h5 class="font-bold mb-2">üî§ Police</h5>
        <p>Plus de 40 polices disponibles : modernes, professionnelles, fantaisie ou monospace</p>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <h5 class="font-bold mb-2">üìè Taille de police</h5>
        <p>Ajustez de 10px √† 28px avec le curseur</p>
      </div>
    </div>
  </section>

  <!-- Export -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">Export</h3>
    <p>T√©l√©chargez vos diagrammes en 3 formats :</p>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-3xl mb-2">üìÑ</div>
        <h5 class="font-bold">SVG</h5>
        <p class="text-xs mt-1">Vectoriel, qualit√© parfaite, id√©al pour l'impression</p>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-3xl mb-2">üñºÔ∏è</div>
        <h5 class="font-bold">PNG</h5>
        <p class="text-xs mt-1">Fond transparent, parfait pour les pr√©sentations</p>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-3xl mb-2">üì∏</div>
        <h5 class="font-bold">JPEG</h5>
        <p class="text-xs mt-1">Fond blanc, compatible partout</p>
      </div>
    </div>
  </section>

  <!-- Syntaxe Mermaid -->
  <section class="space-y-4">
    <h3 class="text-2xl font-bold text-primary">Syntaxe Mermaid - L'essentiel</h3>

    <!-- Flowchart -->
    <div class="border-l-4 border-primary pl-4">
      <h4 class="text-lg font-bold mb-2">Flowchart (organigramme)</h4>
      <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>flowchart LR
    A[D√©but] --&gt; B{D√©cision?}
    B --&gt;|Oui| C[Action 1]
    B --&gt;|Non| D[Action 2]
    C --&gt; E[Fin]
    D --&gt; E</code></pre>
      <div class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2">
        <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">[Texte]</code> Rectangle</div>
        <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">(Texte)</code> Coins arrondis</div>
        <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">{Texte}</code> Losange</div>
        <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">((Texte))</code> Cercle</div>
        <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">[[Texte]]</code> Sous-routine</div>
        <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">[(Texte)]</code> Base de donn√©es</div>
      </div>
      <div class="mt-3">
        <p class="font-semibold text-xs mb-2">Fl√®ches :</p>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">--&gt;</code> Simple</div>
          <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">-.-&gt;</code> Pointill√©e</div>
          <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">==&gt;</code> √âpaisse</div>
          <div class="text-xs"><code class="bg-gray-100 px-2 py-1 rounded">--&gt;|Texte|</code> Avec label</div>
        </div>
      </div>
    </div>

    <!-- Sequence -->
    <div class="border-l-4 border-primary pl-4">
      <h4 class="text-lg font-bold mb-2">Sequence (diagramme de s√©quence)</h4>
      <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>sequenceDiagram
    Patient-&gt;&gt;Infirmier: Arriv√©e
    Infirmier-&gt;&gt;M√©decin: Dossier patient
    M√©decin--&gt;&gt;Infirmier: Instructions
    Infirmier--&gt;&gt;Patient: Prise en charge</code></pre>
    </div>

    <!-- Class -->
    <div class="border-l-4 border-primary pl-4">
      <h4 class="text-lg font-bold mb-2">Class (diagramme de classes)</h4>
      <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>classDiagram
    Patient --&gt; Consultation
    M√©decin --&gt; Consultation
    Consultation --&gt; Ordonnance
    
    class Patient {
        +String nom
        +Date naissance
        +consulter()
    }</code></pre>
    </div>

    <!-- State -->
    <div class="border-l-4 border-primary pl-4">
      <h4 class="text-lg font-bold mb-2">State (diagramme d'√©tats)</h4>
      <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>stateDiagram-v2
    [*] --&gt; Cr√©√©
    Cr√©√© --&gt; EnCours : D√©marrer
    EnCours --&gt; Valid√© : Approuver
    EnCours --&gt; Rejet√© : Refuser
    Valid√© --&gt; [*]
    Rejet√© --&gt; [*]</code></pre>
    </div>

    <!-- ER -->
    <div class="border-l-4 border-primary pl-4">
      <h4 class="text-lg font-bold mb-2">ER Diagram (entit√©-relation)</h4>
      <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-xs leading-5"><code>erDiagram
    PATIENT ||--o{ CONSULTATION : a
    MEDECIN ||--o{ CONSULTATION : r√©alise
    CONSULTATION ||--o{ ORDONNANCE : g√©n√®re</code></pre>
    </div>
  </section>

  <!-- Astuces -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">Astuces</h3>
    <div class="bg-green-50 border-l-4 border-green-500 p-4">
      <ul class="space-y-2">
        <li>‚úÖ <strong>Utilisez l'historique</strong> : Vos 10 derniers prompts sont sauvegard√©s, cliquez dessus pour les r√©utiliser</li>
        <li>‚úÖ <strong>D√©mos rapides</strong> : Cliquez sur "D√©mo Diagramme" pour charger des exemples</li>
        <li>‚úÖ <strong>Validation en temps r√©el</strong> : Un ‚úÖ vert indique que votre syntaxe est correcte</li>
        <li>‚úÖ <strong>Raccourci clavier</strong> : Ctrl+Enter pour g√©n√©rer avec l'IA</li>
        <li>‚úÖ <strong>Pr√©cisez le type</strong> : Commencez toujours votre prompt par le type de diagramme (Flowchart, Sequence, Class, State, ER, Gantt, etc.)</li>
      </ul>
    </div>
  </section>

  <!-- Configuration -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">Configuration</h3>
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
      <h5 class="font-bold mb-2">Param√®tres Mistral AI</h5>
      <ol class="list-decimal pl-5 space-y-1">
        <li>Cliquez sur "Param√®tres"</li>
        <li>Entrez votre cl√© API Mistral</li>
        <li>Testez la connexion</li>
        <li>Sauvegardez</li>
      </ol>
      <div class="mt-3 bg-white border border-gray-300 rounded p-3">
        <p class="font-semibold text-sm mb-2">Mod√®les recommand√©s :</p>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li><code>mistral-large-latest</code> : Le plus puissant</li>
          <li><code>mistral-medium-latest</code> : Bon √©quilibre</li>
          <li><code>mistral-small-latest</code> : Rapide et √©conomique</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Support -->
  <section class="space-y-3">
    <h3 class="text-2xl font-bold text-primary">Support</h3>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <p class="mb-3">Pour toute question ou probl√®me :</p>
      <ul class="space-y-2">
        <li>üìß <strong>Email :</strong> <a href="mailto:sebastien.voerman@enovacom.com" class="text-blue-600 hover:underline">sebastien.voerman@enovacom.com</a></li>
        <li>üìö <strong>Documentation Mermaid compl√®te :</strong> <a href="https://mermaid.js.org" target="_blank" class="text-blue-600 hover:underline">https://mermaid.js.org</a></li>
        <li>üí° <strong>Besoin d'aide ?</strong> D√©crivez simplement ce que vous voulez, l'IA s'occupe du reste !</li>
      </ul>
    </div>
  </section>

  <!-- Footer message -->
  <div class="text-center py-6 border-t border-gray-200">
    <p class="text-lg font-bold text-primary">Vous √™tes pr√™t √† cr√©er des diagrammes professionnels ! üöÄ</p>
  </div>

</div>

    </div>
  </div>

  <!-- App -->
  <script>
    function app(){
      return {
        prompt:'',
        promptHistory:[], // Historique des 10 derniers prompts
        mermaidCode:`sequenceDiagram
autonumber
participant Patient
participant GAMME as GAMME (Gestion Admission)
participant DPI as DPI (Dossier Patient Informatis√©)
Patient->>GAMME: ADT^A01 (Admission)
GAMME->>DPI: ADT^A01 (Cr√©ation dossier patient)
`,
        models:[], selectedModel:'', loading:false, loadingModels:false, lastError:'',
        showSettings:false, showHelp:false,
        
        // Nouvelles propri√©t√©s pour Phase 1
        currentProject: {
          id: null,
          name: '',
          diagram: { mermaid: '', svg: '', include: true, position: 'before_report', title: 'Diagramme' },
          report: { template: 'client_formel', rawNotes: '', generated: '', meta: { date: '', participants: '' } },
          images: [],
          pdfConfig: { 
            logo: '', title: 'Document', client: '', subtitle: '', 
            footer: '{page}/{pages} ‚Ä¢ {projet} ‚Ä¢ {date}', legal: 'ENOVACOM - Tous droits r√©serv√©s', 
            watermark: false, 
            theme: { font: 'Inter', primary: '#0C4A45', margins: { top: 24, right: 18, bottom: 28, left: 18 } },
            order: ['report', 'images', 'diagram']  // Compte rendu en PREMIER pour faciliter copier-coller
          }
        },
        projects: [],
        isGeneratingReport: false,
        isGeneratingPDF: false,
        quillEditor: null, // Instance de l'√©diteur Quill
        reportTemplates: [
          { id: 'client_formel', name: 'Client (formel)' },
          { id: 'sprint_agile', name: 'Sprint Agile' },
          { id: 'brief_technique', name: 'Brief technique' }
        ],
        defaultLogoUrl: '{{ url_for("static", filename="enovacom_logo.png") }}',

        // Visuels - VALEURS PAR D√âFAUT (Enovacom + Poppins)
        theme:'enovacom',
        primaryColor:'#0C4A45',
        fillColor:'#E8F5F4',      // Couleur de remplissage des √©l√©ments
        borderColor:'#0C4A45',     // Couleur des bordures
        textColor:'#0e1f1c',       // Couleur du texte
        fontFamily:"Poppins, sans-serif",  // Police par d√©faut : Poppins
        fontSize:16, // Taille par d√©faut plus lisible
        isRecording:false, recognition:null,

        // Th√®mes riches (couleur des bo√Ætes + fond canvas) - Organis√©s par cat√©gories
        availableThemes:[
          // Th√®mes Clairs Professionnels
          {id:'enovacom',name:'üèõÔ∏è Enovacom', stroke:'#0C4A45', boxBg:'#E8F5F4', boxBorder:'#0C4A45', boxText:'#0e1f1c', canvasBg:'#ffffff', category:'pro'},
          {id:'graphite',name:'üíº Graphite',  stroke:'#334155', boxBg:'#F1F5F9', boxBorder:'#334155', boxText:'#0F172A', canvasBg:'#ffffff', category:'pro'},
          {id:'neutral', name:'‚ö™ Neutre',    stroke:'#6B7280', boxBg:'#F9FAFB', boxBorder:'#6B7280', boxText:'#374151', canvasBg:'#ffffff', category:'pro'},
          {id:'ink',     name:'üñäÔ∏è Encre',     stroke:'#111827', boxBg:'#F3F4F6', boxBorder:'#111827', boxText:'#111827', canvasBg:'#ffffff', category:'pro'},
          {id:'slate',   name:'ü™® Ardoise',   stroke:'#475569', boxBg:'#F8FAFC', boxBorder:'#475569', boxText:'#1E293B', canvasBg:'#ffffff', category:'pro'},
          
          // Th√®mes Sombres
          {id:'midnight',name:'üåô Midnight',  stroke:'#8B5CF6', boxBg:'#1f2937', boxBorder:'#8B5CF6', boxText:'#F3F4F6', canvasBg:'#0F172A', dark:true, category:'dark'},
          {id:'darkblue',name:'üåå Bleu Nuit', stroke:'#3B82F6', boxBg:'#1E293B', boxBorder:'#3B82F6', boxText:'#E2E8F0', canvasBg:'#0F172A', dark:true, category:'dark'},
          {id:'carbon',  name:'‚ö´ Carbone',    stroke:'#10B981', boxBg:'#1F2937', boxBorder:'#10B981', boxText:'#F9FAFB', canvasBg:'#111827', dark:true, category:'dark'},
          {id:'purple',  name:'üíú Pourpre',   stroke:'#A855F7', boxBg:'#1E1B4B', boxBorder:'#A855F7', boxText:'#E9D5FF', canvasBg:'#0F0A1F', dark:true, category:'dark'},
          
          // Th√®mes Bleus & Verts
          {id:'ocean',   name:'üåä Oc√©an',     stroke:'#0EA5E9', boxBg:'#ECFEFF', boxBorder:'#0EA5E9', boxText:'#083344', canvasBg:'#F0FAFF', category:'blue'},
          {id:'cyan',    name:'üíé Cyan',      stroke:'#06B6D4', boxBg:'#ECFEFF', boxBorder:'#06B6D4', boxText:'#164E63', canvasBg:'#ffffff', category:'blue'},
          {id:'sky',     name:'‚òÅÔ∏è Ciel',       stroke:'#0284C7', boxBg:'#E0F2FE', boxBorder:'#0284C7', boxText:'#075985', canvasBg:'#F0F9FF', category:'blue'},
          {id:'emerald', name:'üíö √âmeraude',  stroke:'#10B981', boxBg:'#ECFDF5', boxBorder:'#10B981', boxText:'#064E3B', canvasBg:'#ffffff', category:'green'},
          {id:'forest',  name:'üå≤ For√™t',     stroke:'#065F46', boxBg:'#ECFDF5', boxBorder:'#065F46', boxText:'#064E3B', canvasBg:'#ffffff', category:'green'},
          {id:'lime',    name:'üçã Citron',     stroke:'#84CC16', boxBg:'#F7FEE7', boxBorder:'#84CC16', boxText:'#365314', canvasBg:'#ffffff', category:'green'},
          {id:'mint',    name:'üçÉ Menthe',     stroke:'#14B8A6', boxBg:'#F0FDFA', boxBorder:'#14B8A6', boxText:'#134E4A', canvasBg:'#ffffff', category:'green'},
          
          // Th√®mes Roses & Rouges - Couleurs plus vari√©es
          {id:'rose',    name:'üåπ Rose',       stroke:'#E11D48', boxBg:'#FFE4E6', boxBorder:'#E11D48', boxText:'#881337', canvasBg:'#ffffff', category:'pink'},
          {id:'pink',    name:'üíñ Fuchsia',    stroke:'#EC4899', boxBg:'#FCE7F3', boxBorder:'#EC4899', boxText:'#831843', canvasBg:'#ffffff', category:'pink'},
          {id:'magenta', name:'üíú Magenta',    stroke:'#D946EF', boxBg:'#FAE8FF', boxBorder:'#D946EF', boxText:'#701A75', canvasBg:'#ffffff', category:'pink'},
          
          // Th√®mes Violets
          {id:'violet',  name:'üíú Violet',    stroke:'#7C3AED', boxBg:'#F5F3FF', boxBorder:'#7C3AED', boxText:'#4C1D95', canvasBg:'#ffffff', category:'purple'},
          {id:'lavender',name:'ü™∑ Lavande',   stroke:'#8B5CF6', boxBg:'#F5F3FF', boxBorder:'#8B5CF6', boxText:'#4C1D95', canvasBg:'#ffffff', category:'purple'},
          {id:'indigo',  name:'üîµ Indigo',    stroke:'#6366F1', boxBg:'#EEF2FF', boxBorder:'#6366F1', boxText:'#312E81', canvasBg:'#ffffff', category:'purple'},
          
          // Th√®mes Chauds - Couleurs plus distinctes
          {id:'yellow',  name:'üü° Jaune',     stroke:'#EAB308', boxBg:'#FEF9C3', boxBorder:'#EAB308', boxText:'#713F12', canvasBg:'#ffffff', category:'warm'},
          {id:'amber',   name:'üü† Ambre',      stroke:'#F59E0B', boxBg:'#FEF3C7', boxBorder:'#F59E0B', boxText:'#78350F', canvasBg:'#ffffff', category:'warm'},
          {id:'orange',  name:'üçä Orange',    stroke:'#F97316', boxBg:'#FFEDD5', boxBorder:'#F97316', boxText:'#7C2D12', canvasBg:'#ffffff', category:'warm'},
          {id:'red',     name:'üî¥ Rouge',     stroke:'#DC2626', boxBg:'#FEE2E2', boxBorder:'#DC2626', boxText:'#7F1D1D', canvasBg:'#ffffff', category:'warm'},
          {id:'peach',   name:'üçë P√™che',     stroke:'#FB923C', boxBg:'#FFEDD5', boxBorder:'#FB923C', boxText:'#7C2D12', canvasBg:'#ffffff', category:'warm'}
        ],

        settingsForm:{ base_url:'https://api.mistral.ai', api_key:'' },
        renderTimeout:null,

        /* ---- Helpers couleurs ---- */
        mix(c1, c2, p){ // m√©lange 0..1
          try {
            // S√©curiser p entre 0 et 1
            p = Math.max(0, Math.min(1, Math.abs(p)));
            const a=this.hex2rgb(c1), b=this.hex2rgb(c2);
            const r=Math.max(0, Math.min(255, Math.round(a.r+(b.r-a.r)*p)));
            const g=Math.max(0, Math.min(255, Math.round(a.g+(b.g-a.g)*p)));
            const bl=Math.max(0, Math.min(255, Math.round(a.b+(b.b-a.b)*p)));
            return `#${[r,g,bl].map(x=>x.toString(16).padStart(2,'0')).join('')}`;
          } catch(e) {
            console.error('Mix error:', e, c1, c2, p);
            return c1; // Retourner la couleur d'origine en cas d'erreur
          }
        },
        hex2rgb(hex){ 
          try {
            const m=hex.replace('#',''); 
            return {
              r:parseInt(m.substr(0,2),16) || 0,
              g:parseInt(m.substr(2,2),16) || 0,
              b:parseInt(m.substr(4,2),16) || 0
            };
          } catch(e) {
            return {r:0, g:0, b:0};
          }
        },

        /* ---- Lifecycle ---- */
        init(){
          // Charger depuis localStorage
          this.loadFromStorage();
          
          // FORCER le th√®me Enovacom si c'est le th√®me s√©lectionn√©
          // Cela garantit que les couleurs correspondent bien au th√®me
          if(this.theme === 'enovacom') {
            this.applyTheme(); // Force les couleurs Enovacom
          }
          
          this.applyFontToPage();
          this.loadSettings();
          this.loadModels();
          this.initSpeech();
          this.renderMermaid();
          document.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); this.generate(); }});
        },

        loadFromStorage(){
          try {
            const c=localStorage;
            
            // V√©rifier si c'est le premier lancement
            const isFirstLaunch = !c.getItem('diagflow_theme');
            
            if(isFirstLaunch) {
              // PREMIER LANCEMENT : Forcer Enovacom + Poppins
              console.log('üéâ Premier lancement - Application des param√®tres par d√©faut : Enovacom + Poppins');
              this.theme = 'enovacom';
              this.fontFamily = 'Poppins, sans-serif';
              this.fontSize = 16;
              // Les couleurs seront appliqu√©es par applyTheme() dans init()
            } else {
              // Chargement normal depuis localStorage
              const code=c.getItem('diagflow_code'); if(code) this.mermaidCode=code;
              const theme=c.getItem('diagflow_theme'); if(theme) this.theme=theme;
              const borderColor=c.getItem('diagflow_borderColor'); if(borderColor) this.borderColor=borderColor;
              const fillColor=c.getItem('diagflow_fillColor'); if(fillColor) this.fillColor=fillColor;
              const textColor=c.getItem('diagflow_textColor'); if(textColor) this.textColor=textColor;
              const font=c.getItem('diagflow_font'); if(font) this.fontFamily=font;
              const size=c.getItem('diagflow_fontSize'); if(size) this.fontSize=parseInt(size);
              const model=c.getItem('diagflow_model'); if(model) this.selectedModel=model;
              const history=c.getItem('diagflow_history'); if(history) try{ this.promptHistory=JSON.parse(history); }catch(e){}
            }
            
            // Charger les projets
            const projectsData = c.getItem('pathway_projects');
            if(projectsData) {
              try {
                this.projects = JSON.parse(projectsData);
              } catch(e) {
                console.error('Erreur chargement projets:', e);
                this.projects = [];
              }
            }
          } catch(e) {
            console.error('Erreur chargement localStorage:', e);
            // En cas d'erreur, forcer les valeurs par d√©faut
            this.theme = 'enovacom';
            this.fontFamily = 'Poppins, sans-serif';
            this.fontSize = 16;
          }
        },
        saveToStorage(){
          try {
            const c=localStorage;
            c.setItem('diagflow_code', this.mermaidCode);
            c.setItem('diagflow_theme', this.theme);
            c.setItem('diagflow_borderColor', this.borderColor);
            c.setItem('diagflow_fillColor', this.fillColor);
            c.setItem('diagflow_textColor', this.textColor);
            c.setItem('diagflow_font', this.fontFamily);
            c.setItem('diagflow_fontSize', this.fontSize.toString());
            if(this.selectedModel) c.setItem('diagflow_model', this.selectedModel);
            c.setItem('diagflow_history', JSON.stringify(this.promptHistory));
          } catch(e) {
            console.error('Erreur sauvegarde localStorage:', e);
          }
        },

        // Charger les param√®tres depuis le backend
        async loadSettings(){
          try {
            const response = await fetch('/api/settings');
            if(response.ok){
              const data = await response.json();
              this.settingsForm.base_url = data.mistral_base_url || 'https://api.mistral.ai';
              // Ne pas charger l'API key pour des raisons de s√©curit√© (elle reste sur le serveur)
            }
          } catch(e){
            console.error('Erreur chargement param√®tres:', e);
          }
        },
        
        async loadModels(){
          this.loadingModels=true; this.models=[]; this.selectedModel='';
          try{
            const r=await fetch('/api/mistral/models');
            if(r.ok){ const d=await r.json(); this.models=d.models||[]; this.selectedModel=this.models[0]||''; }
          }catch(e){ /* silencieux */ }
          finally{ this.loadingModels=false; this.saveToStorage(); }
        },
        
        // Tester la connexion Mistral
        async testMistralConnection(){
          if(!this.settingsForm.api_key.trim()){
            this.showToast('Veuillez saisir une API Key', 'error');
            return;
          }
          
          try {
            const response = await fetch('/api/mistral/models', {
              headers: {
                'X-Test-Base-URL': this.settingsForm.base_url,
                'X-Test-API-Key': this.settingsForm.api_key
              }
            });
            
            if(response.ok){
              const data = await response.json();
              this.showToast(`‚úÖ Connexion r√©ussie ! ${data.models.length} mod√®les disponibles`, 'success');
            } else {
              const error = await response.json();
              this.showToast(`‚ùå Erreur: ${error.error || 'Connexion √©chou√©e'}`, 'error');
            }
          } catch(e){
            this.showToast(`‚ùå Erreur: ${e.message}`, 'error');
          }
        },
        
        // Sauvegarder les param√®tres Mistral
        async saveMistralSettings(){
          if(!this.settingsForm.api_key.trim()){
            this.showToast('Veuillez saisir une API Key', 'error');
            return;
          }
          
          try {
            const response = await fetch('/api/settings/mistral', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                base_url: this.settingsForm.base_url,
                api_key: this.settingsForm.api_key
              })
            });
            
            if(response.ok){
              this.showToast('‚úÖ Param√®tres sauvegard√©s', 'success');
              // Recharger les mod√®les avec la nouvelle cl√©
              await this.loadModels();
              this.showSettings = false;
            } else {
              const error = await response.json();
              this.showToast(`‚ùå Erreur: ${error.error || 'Sauvegarde √©chou√©e'}`, 'error');
            }
          } catch(e){
            this.showToast(`‚ùå Erreur: ${e.message}`, 'error');
          }
        },

        debouncedRender(){ clearTimeout(this.renderTimeout); this.renderTimeout=setTimeout(()=>{ this.renderMermaid(); this.saveToStorage(); },250); },

        /* ---- Th√®me ---- */
        applyTheme(){
          const th=this.availableThemes.find(t=>t.id===this.theme);
          if(!th) return;
          
          // RESET COMPLET : Appliquer les couleurs du th√®me (√©crase les personnalisations)
          this.borderColor = th.boxBorder;
          this.fillColor = th.boxBg;
          this.textColor = th.boxText;
          
          console.log('Th√®me appliqu√©:', th.name, {
            borderColor: this.borderColor,
            fillColor: this.fillColor,
            textColor: this.textColor
          });

          // Recolor UI seulement pour Enovacom (branding)
          if(th.id==='enovacom'){
            const r=document.documentElement.style;
            r.setProperty('--primary', '#0C4A45'); r.setProperty('--primary-light', '#0f5650');
            r.setProperty('--primary-dark', '#083832'); r.setProperty('--accent', '#22c55e');
            r.setProperty('--accent-light', '#4ade80');
          }
          
          this.saveToStorage();
          
          // Forcer le re-render imm√©diat pour voir le changement
          this.renderMermaid();
        },
        onFontChange(){ 
          this.applyFontToPage(); 
          this.renderMermaid(); 
          this.saveToStorage(); 
        },
        applyFontToPage(){ 
          const preview=document.getElementById('preview'); 
          if(preview){ 
            preview.style.fontFamily = this.fontFamily;
            preview.style.setProperty('--app-font', this.fontFamily);
            // Appliquer aussi sur le SVG si pr√©sent
            const svg = preview.querySelector('svg');
            if(svg){
              svg.style.fontFamily = this.fontFamily;
              svg.querySelectorAll('*').forEach(el => {
                if(el.tagName === 'text' || el.tagName === 'tspan'){
                  el.style.fontFamily = this.fontFamily;
                }
              });
            }
          } 
        },
        updateColors(){ 
          // Ne pas re-rendre, juste sauvegarder et forcer un refresh
          this.saveToStorage();
          // Attendre un peu puis re-rendre
          setTimeout(() => this.renderMermaid(), 50);
        },

        /* ---- Rendu Mermaid avec couleurs de BO√éTES par th√®me ---- */
        async renderMermaid(){
          if(!this.mermaidCode.trim()){
            document.getElementById('preview').innerHTML='<div class="text-gray-400 text-center py-8">Aucun code √† afficher</div>'; return;
          }
          const th=this.availableThemes.find(t=>t.id===this.theme) || this.availableThemes[0];
          const isDark=!!th.dark;
          const cssFamily=this.fontFamily.replace(/"/g,"'");
          const edgeBg=isDark ? this.mix(th.canvasBg,'#000',.3) : '#ffffff';

          // Utiliser les couleurs personnalis√©es
          const strokeColor = this.borderColor || th.boxBorder;
          const fillBg = this.fillColor || th.boxBg;
          const textCol = this.textColor || th.boxText;
          
          // Calculer les couleurs d√©riv√©es de mani√®re s√©curis√©e
          const clusterFill = this.mix(fillBg, isDark ? '#000000' : '#ffffff', 0.15);
          const noteFill = this.mix(fillBg, isDark ? '#000000' : '#ffffff', 0.1);
          
          const themeCSS = `
            svg { 
              background:${th.canvasBg} !important; 
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* POLICE ET TAILLE - Forcer sur TOUS les √©l√©ments texte */
            text, tspan, .nodeLabel, .edgeLabel, .label, .messageText, .noteText,
            .actor text, .labelText, .titleText, .classText, .stateText,
            .er .entityLabel, .taskText, .sectionTitle, .gridLabel {
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Flowchart - TOUS les types de noeuds */
            .node rect, .node polygon, .node circle, .node ellipse, .node path { 
              fill:${fillBg} !important; 
              stroke:${strokeColor} !important; 
            }
            .node text, .nodeLabel { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Flowchart - Formes sp√©ciales (losanges, cercles, etc.) */
            .label-container rect, .label-container polygon, .label-container circle { 
              fill:${fillBg} !important; 
              stroke:${strokeColor} !important; 
            }
            
            /* Clusters / Subgraphs */
            .cluster rect, .cluster polygon { 
              fill:${clusterFill} !important; 
              stroke:${strokeColor} !important; 
            }
            .cluster text, .cluster .nodeLabel { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Edge labels & titles */
            .edgeLabel, .label { 
              color:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            .edgeLabel rect, .edgeLabel polygon { fill:${edgeBg} !important; }
            .edgeLabel text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Sequence diagram */
            .actor, .actor-box { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .actor rect, .actor polygon { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .actor text, .actor-man text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            .note { fill:${noteFill} !important; stroke:${strokeColor} !important; }
            .noteText, .messageText { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* Class diagram */
            .classGroup rect { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .classGroup text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* State diagram */
            .stateGroup rect, .stateGroup circle { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .stateGroup text { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            
            /* ER diagram */
            .er .entityBox { fill:${fillBg} !important; stroke:${strokeColor} !important; }
            .er .entityLabel { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
            .er .attributeBoxEven, .er .attributeBoxOdd { fill:${fillBg} !important; }
            
            /* Gantt */
            .grid .tick { stroke:${strokeColor} !important; }
            .taskText { 
              fill:${textCol} !important;
              font-family: ${cssFamily} !important;
              font-size: ${this.fontSize}px !important;
            }
          `;

          try{
            mermaid.initialize({
              startOnLoad:false,
              securityLevel:'loose',
              theme: 'base',
              themeVariables:{
                fontFamily: cssFamily,
                fontSize: this.fontSize + 'px',
                
                // Couleurs principales
                primaryColor: fillBg,
                primaryBorderColor: strokeColor,
                primaryTextColor: textCol,
                
                // Lignes et bordures
                lineColor: strokeColor,
                border1: strokeColor,
                border2: strokeColor,
                
                // Backgrounds
                background: th.canvasBg,
                mainBkg: fillBg,
                secondBkg: fillBg,
                tertiaryColor: fillBg,
                
                // Clusters
                clusterBkg: clusterFill,
                clusterBorder: strokeColor,
                
                // Notes et labels
                noteBkgColor: noteFill,
                noteBorderColor: strokeColor,
                edgeLabelBackground: edgeBg,
                labelColor: textCol,
                
                // Sequence diagram
                actorBkg: fillBg,
                actorBorder: strokeColor,
                actorTextColor: textCol,
                actorLineColor: strokeColor,
                signalColor: strokeColor,
                signalTextColor: textCol,
                
                // Class diagram
                classText: textCol,
                
                // State diagram  
                labelBoxBkgColor: fillBg,
                labelBoxBorderColor: strokeColor,
                labelTextColor: textCol,
                
                // ER diagram
                attributeBackgroundColorOdd: fillBg,
                attributeBackgroundColorEven: fillBg
              },
              themeCSS
            });

            const preview=document.getElementById('preview');
            preview.innerHTML='';
            const { svg } = await mermaid.render('mermaid-diagram', this.mermaidCode);
            preview.innerHTML=svg;

            // FORCER la police et la taille sur TOUS les √©l√©ments texte
            const svgEl=preview.querySelector('svg');
            if(svgEl){ 
              svgEl.style.fontFamily=this.fontFamily; 
              svgEl.style.fontSize=this.fontSize+'px';
              
              // Forcer sur tous les √©l√©ments texte
              svgEl.querySelectorAll('text, tspan, .nodeLabel, .edgeLabel, .label, .messageText, .noteText, .actor text, .labelText, .titleText, .classText, .stateText, .taskText').forEach(el => {
                el.style.fontFamily = this.fontFamily;
                el.style.fontSize = this.fontSize + 'px';
              });
            }
            this.lastError='';
          }catch(err){
            this.lastError = err?.message || 'Erreur Mermaid';
            document.getElementById('preview').innerHTML = `<div class="text-red-600 text-center py-8">‚ùå ${this.lastError}</div>`;
          }
        },

        /* ---- Dict√©e ---- */
        initSpeech(){
          const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
          if(!Rec) return;
          this.recognition=new Rec(); this.recognition.continuous=true; this.recognition.interimResults=true; this.recognition.lang='fr-FR';
          this.recognition.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const t=e.results[i][0].transcript; if(e.results[i].isFinal) this.prompt=(this.prompt.trim()?this.prompt+' ':'')+t.trim(); } };
          this.recognition.onerror=()=>{ this.isRecording=false; }; this.recognition.onend=()=>{ this.isRecording=false; };
        },
        toggleDictation(){ if(!this.recognition){ this.showToast('Dict√©e non support√©e','error'); return; } this.isRecording?this.stopDictation():this.startDictation(); },
        startDictation(){ try{ this.recognition.start(); this.isRecording=true; this.showToast('Dict√©e d√©marr√©e','success'); }catch(e){ this.showToast('Impossible de d√©marrer la dict√©e','error'); } },
        stopDictation(){ try{ this.recognition.stop(); }catch(e){} this.isRecording=false; this.showToast('Dict√©e arr√™t√©e','success'); },

        /* ---- G√©n√©ration ---- */
        async generate(){
          if(!this.prompt.trim()){ this.showToast('Veuillez saisir un prompt','error'); return; }
          this.loading=true;
          try{
            const r=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:this.prompt,engine:'mistral',model:this.selectedModel})});
            const d=await r.json();
            if(r.ok){ 
              this.mermaidCode=d.mermaid; 
              this.addToHistory(this.prompt);
              this.renderMermaid(); 
              this.showToast('Diagramme g√©n√©r√© !','success'); 
            }
            else{ this.showToast(d.error||'Erreur lors de la g√©n√©ration','error'); }
          }catch(e){ this.showToast('Erreur r√©seau','error'); }
          finally{ this.loading=false; }
        },

        addToHistory(promptText){
          if(!promptText || !promptText.trim()) return;
          const text = promptText.trim();
          // √âviter les doublons
          this.promptHistory = this.promptHistory.filter(p => p !== text);
          // Ajouter au d√©but
          this.promptHistory.unshift(text);
          // Limiter √† 10
          if(this.promptHistory.length > 10) this.promptHistory = this.promptHistory.slice(0, 10);
          this.saveToStorage();
        },

        loadFromHistory(promptText){
          this.prompt = promptText;
          this.showToast('Prompt charg√© depuis l\'historique','success');
        },

        clearHistory(){
          if(confirm('Voulez-vous vraiment effacer tout l\'historique ?')){
            this.promptHistory = [];
            this.saveToStorage();
            this.showToast('Historique effac√©','success');
          }
        },

        loadDemoByType(type){
          const demoExamples = {
            flowchart: `flowchart LR
  A[Arriv√©e patient] --> B{Urgence ?}
  B -- Oui --> C((Triage prioritaire))
  B -. Non .-> D[Accueil standard]
  C ==> E[Consultation]
  D --> E`,
            sequence: `sequenceDiagram
  autonumber
  participant P as Patient
  participant I as Infirmier
  participant M as M√©decin

  P ->> I: Arriv√©e
  I ->> M: Dossier
  activate M
  M -->> I: Instructions
  deactivate M

  Note over P,I: Accueil & triage

  alt Urgent
    I ->> M: Appel prioritaire
  else Standard
    I ->> P: Salle d'attente
  end`,
            class: `classDiagram
  class Patient {
    +id: string
    +nom: string
    +admettre()
  }
  class Dossier {
    +id: string
    +etat: string
  }
  Patient "1" -- "1" Dossier : poss√®de
  Dossier <|-- DossierUrgent : h√©rite`,
            state: `stateDiagram-v2
  [*] --> EnAttente
  EnAttente --> EnCours: d√©clencher
  EnCours --> Termin√©: finir
  state EnCours {
    [*] --> Traitement
    Traitement --> Validation
    Validation --> [*]
  }
  Termin√© --> [*]`,
            er: `erDiagram
  PATIENT ||--o{ DOSSIER : a
  DOSSIER ||--o{ EXAMEN : contient
  PATIENT {
    string id PK
    string nom
  }
  DOSSIER {
    string id PK
    string etat
  }`,
            gantt: `gantt
  title Parcours patient
  dateFormat  YYYY-MM-DD
  section Accueil
  Admission       :a1, 2025-04-01, 1d
  Triage          :after a1, 1d
  section Soins
  Examens         :crit, 2d
  Diagnostic      :1d`,
            pie: `pie showData
  title R√©partition des actes m√©dicaux
  "Consultations" : 45
  "Examens" : 30
  "Urgences" : 15
  "Hospitalisations" : 10`,
            gitgraph: `gitGraph
  commit
  branch develop
  checkout develop
  commit
  commit
  checkout main
  merge develop
  commit
  branch feature
  checkout feature
  commit
  checkout main
  merge feature
  commit`,
            journey: `journey
  title Parcours Patient
  section Admission
    Accueil: 5: Patient
    Triage: 3: Infirmier
    Dossier: 2: Syst√®me
  section Consultation
    Examen: 4: M√©decin
    Diagnostic: 3: M√©decin
    Traitement: 5: √âquipe m√©dicale
  section Suivi
    Sortie: 2: Infirmier
    RDV Suivi: 1: Syst√®me`
          };
          
          this.mermaidCode = demoExamples[type] || demoExamples.flowchart;
          this.renderMermaid(); 
          this.showToast('D√©mo charg√©e !','success');
        },

        /* ---- Export fiable (toBlob) ---- */
        exportSvg(){
          const svg=document.querySelector('#preview svg');
          if(!svg){ this.showToast('Aucun diagramme √† exporter','error'); return; }
          const data=new XMLSerializer().serializeToString(svg);
          const blob=new Blob([data],{type:'image/svg+xml'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download='diagram.svg';
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          this.showToast('SVG t√©l√©charg√©','success');
        },
        async exportPng(scale=2){ await this.exportRaster('image/png','png',scale,1); },
        async exportJpeg(scale=2,quality=.92){ await this.exportRaster('image/jpeg','jpg',scale,quality); },

        async exportRaster(mime,ext,scale,quality){
          const svg=document.querySelector('#preview svg');
          if(!svg){ this.showToast('Aucun diagramme √† exporter','error'); return; }

          try{
            // Attendre que toutes les polices soient charg√©es
            if(document.fonts && document.fonts.ready){ 
              await document.fonts.ready; 
              // Petit d√©lai suppl√©mentaire pour s√©curiser le rendu
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          }catch(e){ console.warn('Font loading timeout:', e); }

          // Utiliser html2canvas ou une approche diff√©rente pour √©viter CORS
          // On va dessiner directement le SVG sans passer par une image interm√©diaire
          
          let w, h;
          const vb = svg.getAttribute('viewBox');
          if(vb){ 
            const p = vb.trim().split(/\s+/).map(Number); 
            w = p[2]; h = p[3]; 
          } else { 
            const bbox = svg.getBBox(); 
            w = bbox.width; h = bbox.height; 
          }
          w = Math.max(1, Math.floor(w));
          h = Math.max(1, Math.floor(h));

          const canvas = document.createElement('canvas');
          canvas.width = Math.round(w * scale);
          canvas.height = Math.round(h * scale);
          const ctx = canvas.getContext('2d');

          // Fond blanc pour JPEG
          if(mime === 'image/jpeg'){
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }

          // Cloner et pr√©parer le SVG
          const clone = svg.cloneNode(true);
          if(!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          clone.setAttribute('width', w);
          clone.setAttribute('height', h);
          
          // Forcer la police
          clone.style.fontFamily = this.fontFamily;
          clone.style.fontSize = this.fontSize + 'px';

          const svgStr = new XMLSerializer().serializeToString(clone);
          
          // CORRECTION CRITIQUE : Utiliser data URL au lieu de blob URL pour √©viter CORS
          const svgBase64 = btoa(unescape(encodeURIComponent(svgStr)));
          const url = `data:image/svg+xml;base64,${svgBase64}`;

          const img = new Image();
          img.onload = () => {
            ctx.setTransform(scale, 0, 0, scale, 0, 0);
            ctx.drawImage(img,0,0,w,h);

            canvas.toBlob((blob)=>{
              const outUrl=URL.createObjectURL(blob);
              const a=document.createElement('a'); a.href=outUrl; a.download=`diagram.${ext}`;
              document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(outUrl);
              URL.revokeObjectURL(url);
              this.showToast(`${ext.toUpperCase()} t√©l√©charg√©`,'success');
            }, mime, quality);
          };
          img.onerror=()=>{ URL.revokeObjectURL(url); this.showToast('Erreur export','error'); };
          img.src=url;
        },
        
        showToast(msg,type='success'){ const t=document.getElementById('toast'); t.textContent=msg; t.className=`neo-toast ${type} show`; setTimeout(()=>{ t.className=`neo-toast ${type}`; },2400); },
        
        // Commandes WYSIWYG pour l'√©diteur
        execCommand(command, value = null){
          document.execCommand(command, false, value);
          document.getElementById('wysiwyg-editor')?.focus();
        },
        
        clearFormatting(){
          document.execCommand('removeFormat', false, null);
          document.getElementById('report-editor')?.focus();
        },
        
        // Forcer la mise √† jour de l'ordre PDF pour les projets existants
        updatePdfOrder(){
          // Mettre √† jour l'ordre pour le projet actuel
          this.currentProject.pdfConfig.order = ['report', 'images', 'diagram'];
          this.saveProject();
          this.showToast('Ordre PDF mis √† jour : Compte rendu en premier !', 'success');
        },
        
        // Copier le compte rendu vers le diagramme Mermaid
        copyReportToDiagram(){
          if(!this.currentProject.report.generated){
            this.showToast('Aucun compte rendu √† copier', 'error');
            return;
          }
          
          // Extraire le texte brut du HTML
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = this.currentProject.report.generated;
          const plainText = tempDiv.textContent || tempDiv.innerText || '';
          
          // Cr√©er un prompt Mermaid bas√© sur le contenu du CR
          const mermaidPrompt = `Flowchart: Cr√©er un diagramme de flux bas√© sur ce compte rendu:\n\n${plainText.substring(0, 500)}${plainText.length > 500 ? '...' : ''}`;
          
          // Mettre √† jour le prompt et g√©n√©rer automatiquement
          this.prompt = mermaidPrompt;
          this.addToHistory(this.prompt);
          
          // Basculer vers l'onglet diagramme
          this.activeTab = 'diagram';
          
          // G√©n√©rer automatiquement le diagramme
          setTimeout(() => {
            this.generateDiagram();
          }, 100);
          
          this.showToast('Compte rendu copi√© vers le diagramme !', 'success');
        },
        
        // Gestion du logo
        async uploadLogo(event){
          const file = event.target.files?.[0];
          if(!file) return;
          
          if(!file.type.match(/^image\/(jpeg|png)$/)){
            this.showToast('Format non support√© (JPEG/PNG uniquement)', 'error');
            return;
          }
          
          if(file.size > 1 * 1024 * 1024){
            this.showToast('Logo trop lourd (max 1 Mo)', 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            this.currentProject.pdfConfig.logo = e.target.result;
            this.saveProject();
            this.showToast('Logo ajout√©', 'success');
          };
          reader.readAsDataURL(file);
          
          // R√©initialiser l'input pour permettre de recharger le m√™me fichier
          event.target.value = '';
        },
        
        async setDefaultLogo(){
          // Charger le logo Enovacom depuis le serveur et le convertir en base64
          try {
            const response = await fetch(this.defaultLogoUrl);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.onload = (e) => {
              this.currentProject.pdfConfig.logo = e.target.result;
              this.showToast('Logo Enovacom ajout√©', 'success');
            };
            reader.readAsDataURL(blob);
          } catch(e){
            this.showToast('Erreur chargement logo', 'error');
          }
        },
        
        // Initialiser Quill
        initTinyMCE(){
          const self = this;
          
          // Attendre que Quill et le module table soient charg√©s
          const initEditor = () => {
            if(!window.Quill || !window.QuillBetterTable){
              setTimeout(initEditor, 100);
              return;
            }
            
            // Enregistrer le module table
            Quill.register('modules/better-table', window.QuillBetterTable.default);
            
            // Initialiser Quill
            self.quillEditor = new Quill('#quill-editor', {
              theme: 'snow',
              modules: {
                toolbar: [
                  [{ 'header': [1, 2, 3, false] }],
                  ['bold', 'italic', 'underline', 'strike'],
                  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                  [{ 'align': [] }],
                  ['link'],
                  ['clean'],
                  [{ 'table': 'TD' }]
                ],
                'better-table': {
                  operationMenu: {
                    items: {
                      unmergeCells: {
                        text: 'S√©parer les cellules'
                      }
                    }
                  }
                },
                keyboard: {
                  bindings: window.QuillBetterTable.keyboardBindings
                }
              },
              placeholder: 'Le compte rendu g√©n√©r√© appara√Ætra ici...'
            });
            
            // Ajouter le bouton d'insertion de tableau dans la toolbar
            const toolbar = self.quillEditor.getModule('toolbar');
            toolbar.addHandler('table', () => {
              const tableModule = self.quillEditor.getModule('better-table');
              tableModule.insertTable(3, 3);
            });
            
            // Sauvegarde automatique
            self.quillEditor.on('text-change', () => {
              self.currentProject.report.generated = self.quillEditor.root.innerHTML;
              self.saveProject();
            });
          };
          
          initEditor();
        },
        
        // Copier le texte du rapport
        copyReportText(){
          if(this.quillEditor){
            const text = this.quillEditor.getText();
            navigator.clipboard.writeText(text);
            this.showToast('Copi√©!', 'success');
          }
        },
        
        // Effacer le rapport
        clearReport(){
          if(confirm('√ätes-vous s√ªr de vouloir effacer le compte rendu ?')){
            this.currentProject.report.generated = '';
            if(this.quillEditor){
              this.quillEditor.setContents([]);
            }
            this.saveProject();
            this.showToast('Compte rendu effac√©', 'success');
          }
        },
        
        // Convertir markdown en HTML pour l'√©diteur (ancienne fonction, gard√©e pour compatibilit√©)
        convertMarkdownToHTML(markdown){
          if(!markdown) return '';
          
          let html = markdown;
          
          // Titres
          html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
          html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
          
          // Gras et italique
          html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
          html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
          
          // Listes √† puces
          html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
          html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
          
          // Listes num√©rot√©es  
          html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
          
          // Paragraphes
          html = html.replace(/\n\n/g, '</p><p>');
          html = '<p>' + html + '</p>';
          
          // Nettoyer les <p> vides
          html = html.replace(/<p><\/p>/g, '');
          html = html.replace(/<p>(<[uh][l123]>)/g, '$1');
          html = html.replace(/(<\/[uh][l123]>)<\/p>/g, '$1');
          
          return html;
        },

        /* ---- Nouvelles fonctions Phase 1 ---- */
        
        // G√©n√©ration de compte rendu
        async generateReport(){
          if(!this.currentProject.report.rawNotes.trim()){
            this.showToast('Veuillez saisir des notes', 'error');
            return;
          }
          
          this.isGeneratingReport = true;
          try {
            const response = await fetch('/api/generate-report', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                notes: this.currentProject.report.rawNotes,
                template: this.currentProject.report.template,
                meta: this.currentProject.report.meta
              })
            });
            
            if(!response.ok){
              const err = await response.json();
              throw new Error(err.error || 'Erreur g√©n√©ration');
            }
            
            const data = await response.json();
            
            // R√©soudre l'instance Marked (compat global/UMD et versions)
            const _mk = (window.marked && (window.marked.parse ? window.marked : (window.marked.marked ? window.marked.marked : null))) || null;
            if(!_mk){
              throw new Error('Marked non charg√©');
            }
            // Configurer marked.js (si disponible sur cette version)
            if(typeof _mk.setOptions === 'function'){
              _mk.setOptions({
                gfm: true,
                breaks: true,
                headerIds: false,
                mangle: false
              });
            }
            // Convertir le markdown en HTML avec marked.js
            const htmlContent = (typeof _mk.parse === 'function') ? _mk.parse(data.report) : _mk(data.report);
            this.currentProject.report.generated = htmlContent;
            
            console.log('‚úÖ HTML g√©n√©r√©:', htmlContent.substring(0, 500));
            
            this.saveProject();
            this.showToast('Compte rendu g√©n√©r√©', 'success');
          } catch(e){
            this.showToast(e.message, 'error');
          } finally {
            this.isGeneratingReport = false;
          }
        },
        
        // Gestion des images

        // ====== Outils d'√©dition ======
        focusEditor(){
          const el = document.getElementById('report-editor');
          if(el){ el.focus(); }
        },
        format(cmd){
          this.focusEditor();
          document.execCommand(cmd, false, null);
          this.saveProject();
        },
        setHeading(level){
          this.focusEditor();
          document.execCommand('formatBlock', false, 'H'+level);
          this.saveProject();
        },
        clearFormatting(){
          this.focusEditor();
          document.execCommand('removeFormat', false, null);
          this.saveProject();
        },
        undo(){
          this.focusEditor();
          document.execCommand('undo', false, null);
        },
        redo(){
          this.focusEditor();
          document.execCommand('redo', false, null);
        },
        insertTable(){
          this.focusEditor();
          const html = `
            <table>
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Responsable</th>
                  <th>√âch√©ance</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
                </tr>
              </tbody>
            </table>`;
          document.execCommand('insertHTML', false, html);
          this.saveProject();
        },
        onEditorKeydown(e){
          if((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === 'z'){
            e.preventDefault();
            this.undo();
          } else if((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))){
            e.preventDefault();
            this.redo();
          }
        },
        async addImage(event){
          const files = event.target.files || event.dataTransfer?.files;
          if(!files || !files.length) return;
          
          for(let file of files){
            if(!file.type.match(/^image\/(jpeg|png)$/)){
              this.showToast('Format non support√© (JPEG/PNG uniquement)', 'error');
              continue;
            }
            
            if(file.size > 2 * 1024 * 1024){
              this.showToast('Image trop lourde (max 2 Mo)', 'error');
              continue;
            }
            
            if(this.currentProject.images.length >= 10){
              this.showToast('Maximum 10 images', 'error');
              break;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
              this.currentProject.images.push({
                id: Date.now() + Math.random(),
                name: file.name,
                dataUrl: e.target.result,
                caption: ''
              });
              this.saveProject();
            };
            reader.readAsDataURL(file);
          }
        },
        
        removeImage(id){
          this.currentProject.images = this.currentProject.images.filter(img => img.id !== id);
          this.saveProject();
        },
        
        moveImageUp(idx){
          if(idx > 0){
            const temp = this.currentProject.images[idx];
            this.currentProject.images[idx] = this.currentProject.images[idx - 1];
            this.currentProject.images[idx - 1] = temp;
            this.saveProject();
          }
        },
        
        moveImageDown(idx){
          if(idx < this.currentProject.images.length - 1){
            const temp = this.currentProject.images[idx];
            this.currentProject.images[idx] = this.currentProject.images[idx + 1];
            this.currentProject.images[idx + 1] = temp;
            this.saveProject();
          }
        },
        
        // G√©n√©ration PDF
        async generatePDF(){
          if(!this.currentProject.report.generated){
            this.showToast('Aucun contenu √† exporter', 'error');
            return;
          }
          
          this.isGeneratingPDF = true;
          try {
            // DIAGRAMME SUPPRIM√â - L'utilisateur peut l'exporter manuellement et l'ajouter via Images
            console.log('üìä Diagramme ignor√© - Utilisez la section Images pour ajouter le diagramme');
            
            const response = await fetch('/api/generate-pdf', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ project: this.currentProject })
            });
            
            if(!response.ok){
              const err = await response.json();
              throw new Error(err.error || 'Erreur g√©n√©ration PDF');
            }
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${this.currentProject.pdfConfig.title.replace(/\s+/g, '_')}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            this.showToast('PDF t√©l√©charg√©', 'success');
          } catch(e){
            this.showToast(e.message, 'error');
          } finally {
            this.isGeneratingPDF = false;
          }
        },
        
        // Sauvegarde projet
        saveProject(){
          try {
            if(!this.currentProject.id){
              this.currentProject.id = Date.now();
              this.currentProject.createdAt = new Date().toISOString();
            }
            this.currentProject.updatedAt = new Date().toISOString();
            
            // Synchroniser le nom du projet avec le titre PDF
            if(this.currentProject.pdfConfig.title && this.currentProject.pdfConfig.title !== 'Document'){
              this.currentProject.name = this.currentProject.pdfConfig.title;
            }
            
            const idx = this.projects.findIndex(p => p.id === this.currentProject.id);
            if(idx >= 0){
              this.projects[idx] = JSON.parse(JSON.stringify(this.currentProject));
            } else {
              this.projects.unshift(JSON.parse(JSON.stringify(this.currentProject)));
            }
            
            // Limiter √† 20 projets
            if(this.projects.length > 20){
              this.projects = this.projects.slice(0, 20);
            }
            
            localStorage.setItem('pathway_projects', JSON.stringify(this.projects));
          } catch(e){
            console.error('Erreur sauvegarde:', e);
          }
        },
        
        loadProject(id){
          const project = this.projects.find(p => p.id === id);
          if(project){
            this.currentProject = JSON.parse(JSON.stringify(project));
            if(this.currentProject.diagram.mermaid){
              this.mermaidCode = this.currentProject.diagram.mermaid;
              this.renderMermaid();
            }
            
            // Le contenu du rapport sera charg√© automatiquement par x-html
            
            this.showToast('Projet charg√©', 'success');
          }
        },
        
        deleteProject(id){
          if(confirm('Supprimer ce projet ?')){
            this.projects = this.projects.filter(p => p.id !== id);
            localStorage.setItem('pathway_projects', JSON.stringify(this.projects));
            this.showToast('Projet supprim√©', 'success');
          }
        },
        
        clearAllProjects(){
          if(confirm('‚ö†Ô∏è Voulez-vous vraiment effacer TOUT l\'historique des projets ?\n\nCette action est irr√©versible.')){
            this.projects = [];
            localStorage.setItem('pathway_projects', JSON.stringify(this.projects));
            this.showToast('Historique effac√©', 'success');
          }
        },
        
        newProject(){
          this.currentProject = {
            id: null,
            name: '',
            diagram: { mermaid: '', svg: '', include: true, position: 'before_report', title: 'Diagramme' },
            report: { template: 'client_formel', rawNotes: '', generated: '', meta: { date: '', participants: '' } },
            images: [],
            pdfConfig: { 
              logo: '', title: 'Document', client: '', subtitle: '', 
              footer: '{page}/{pages} ‚Ä¢ {projet} ‚Ä¢ {date}', legal: 'ENOVACOM - Tous droits r√©serv√©s', 
              watermark: false, 
              theme: { font: 'Inter', primary: '#0C4A45', margins: { top: 24, right: 18, bottom: 28, left: 18 } },
              order: ['report', 'images', 'diagram']  // Diagramme √† la fin par d√©faut
            }
          };
          this.mermaidCode = '';
          this.renderMermaid();
        }
      }
    }
  </script>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-12">
    <div class="max-w-7xl mx-auto px-6 py-6">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-gray-600">
        <div class="flex items-center gap-2">
          <span class="font-semibold text-primary">¬© 2025 Enovacom</span>
          <span>‚Ä¢</span>
          <span>Tous droits r√©serv√©s</span>
        </div>
        <div class="flex flex-wrap justify-center gap-4">
          <a href="/mentions-legales" class="hover:text-primary transition-colors">Mentions l√©gales</a>
          <span>‚Ä¢</span>
          <a href="/confidentialite" class="hover:text-primary transition-colors">Politique de confidentialit√©</a>
          <span>‚Ä¢</span>
          <a href="/conditions" class="hover:text-primary transition-colors">Conditions d'utilisation</a>
          <span>‚Ä¢</span>
          <a href="mailto:sebastien.voerman@enovacom.com" class="hover:text-primary transition-colors">Contact</a>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>
